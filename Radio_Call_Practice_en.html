<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Call | Aviation English | Yohann's Aviation Notes</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G3TQJTQ67B"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-G3TQJTQ67B');
    </script>

</head>

<style>
    /* æ–°å¢æ ·å¼ï¼šå¯¼èˆªè·¯å¾„æ ·å¼ */
    .breadcrumb {
        padding: 1rem;
        padding-left: 10%;
        background: var(--background-color);
        box-shadow: var(--shadow-sm);
    }

    .breadcrumb a {
        text-decoration: none;
        color: var(--text-color);
        font-size: 1rem;
        transition: var(--transition);
    }

        .breadcrumb a:hover {
            color: var(--primary-color);
        }

    .breadcrumb span {
        color: var(--text-color);
        font-size: 0.9rem;
        margin: 0 0.5rem;
    }
</style>

<style>
.nav-breadcrumb-container {
    position: -webkit-sticky; /* Safari */
    position: sticky;
    top: 0;
    background-color:; /* å¯é€‰ï¼šè®¾ç½®èƒŒæ™¯é¢œè‰² */
    z-index: 1000; /* ç¡®ä¿å®ƒåœ¨å…¶ä»–å†…å®¹ä¹‹ä¸Š */
}

</style>
<body>

    <header>
        <div class="language-switcher">
            <a href="Radio_Call_Practice.html">ä¸­æ–‡</a> | <a href="Radio_Call_Practice_en.html">English</a>
        </div>
        <div class="header-content">
            <h1>Radio Call</h1>
        </div>
    </header>

    <div class="nav-breadcrumb-container">
        <nav>
            <ul>
                <li><a href="index_en.html">Home</a></li>
                <li><a href="theory_en.html">Theory Exams</a></li>
                <li><a href="aviation-english_en.html"  class="active">Aviation English</a></li>
                <li><a href="about_en.html">About Me</a></li>
            </ul>
        </nav>

        <!-- å¯¼èˆªè·¯å¾„ -->
        <div class="breadcrumb">
            <a href="aviation-english_en.html">All Topics</a>
            <span>></span>
            <a id="subject-name">Radio Call</a>
        </div>
        
    </div>

    <main class="container">
        <section id="radio call into" class="section">
            <h2>Basic Call Sign Pronunciation</h2>
            <p>Call signs are identifiers for aircraft, consisting of letters and numbers.</p>
            <h3>Pronunciation Rules</h3>
                <li>Letters: A (Alpha), B (Bravo), C (Charlie), D (Delta), E (Echo), F (Foxtrot), G (Golf), H (Hotel), I (India), J (Juliet), K (Kilo), L (Lima), M (Mike), N (November), O (Oscar), P (Papa), Q (Quebec), R (Romeo), S (Sierra), T (Tango), U (Uniform), V (Victor), W (Whiskey), X (X-ray), Y (Yankee), Z (Zulu)</li>
                <li>Numbers: 3 (Tree), 9 (Niner); numbers in call signs are grouped in pairs</li>
            <h3>Pronunciation Examples</h3>
                <li>AI9: "Alpha India Niner", 8470: "Eighty Four Seventy", 172D: "One Seventy Two Delta"</li>

                <style>
                    .section {
                        padding: 3em;
                    }
                    
                    .section h2 {
                        font-size: 1.8em;
                        margin-bottom: 0.5em;
                        border-bottom: 2.5px solid var(--primary-color);
                        padding-bottom: 0.2em;
                    }
                    
                    .section h3 {
                        font-size: 1.4em;
                        margin-top: 1em;
                        margin-bottom: 0.5em;
                        color: #333;
                    }
                    
                    .section h4 {
                        font-size: 1.1em;
                        margin-top: 0.8em;
                        margin-bottom: 0.4em;
                        color: var(--primary-color);
                    }
                    
                    .section ul {
                        list-style-type: disc;
                        margin-left: 1.5em;
                        margin-bottom: 1em;
                    }
                    
                    .section ul li {
                        margin-bottom: 0.5em;
                    }
                    
                    .section p {
                        margin-bottom: 1em;
                        line-height: 1.6;
                    }
                    </style>
        </section>

        <section id="Real_AU_callsign_reader" class="section">
            <h2>Call Sign Dictation Practice</h2>
            <p>**This version is for testing purposes only; usage policies will be adjusted later.**</p>
            <h3>Instructions</h3>
            <h4>Call Sign Practice Mode</h4>
            <p>Click the "Simulated Call Sign" button to play simulated traffic "aircraft type" and "call sign." Practice correctly identifying and transcribing the "call sign" (write only the call sign).</p>
            <h4>Letter Practice Mode</h4>
            <p>Click "Letter Practice" to practice letter dictation; you can customize the letters to practice, such as XYZR, with the default being A-Z.</p>
            <details>
                <summary>More Options</summary>
                <div class="control-group">
                    <div class="input-group">
                        <label>Number of Call Signs per Group:</label>
                        <input type="number" id="callsignCount" value="1" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label>Custom Letters:</label>
                        <input type="text" id="customLetters" maxlength="26" placeholder="Letter Practice: e.g., XYZR, default A-Z">
                    </div>
                    <div class="input-group">
                        <label>Number of Letters per Group:</label>
                        <input type="number" id="letterCount" value="9" min="1" max="50">
                    </div>
                </div>
                <div class="control-group">
                    <div id="speedControl">
                        <label>Speed Adjustment
                            <input type="range" id="speed" min="0.3" max="2" value="1.2" step="0.1" oninput="updateSpeed(this.value)">
                            <span id="speedValue">1.2</span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label style="cursor: pointer;">
                            Diverse Voices (Australia) <input type="checkbox" id="voiceDiversity">
                        </label>
                    </div>
                    <div class="input-group">
                        <label style="cursor: pointer;">
                            Simulate Radio Tone <input type="checkbox" id="simulateRadio"> 
                        </label>
                    </div>
                </div>
            </details>
            <style>
                /* åŸºç¡€æŠ˜å é¢æ¿æ ·å¼ */
                details {
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    margin: 1rem 0;
                    transition: all 0.3s ease;
                }
                
                /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
                details:hover {
                    border-color: #3498db;
                    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
                }
                
                /* æ ‡é¢˜æ ·å¼ */
                details summary {
                    padding: 12px 16px;
                    background: #f8f9fa;
                    color: #2c3e50;
                    font-weight: 500;
                    cursor: pointer;
                    list-style: none; /* éšè—é»˜è®¤ç®­å¤´ */
                    border-radius: 8px 8px 0 0;
                    position: relative;
                    transition: background 0.2s ease;
                }
                
                /* ç§»é™¤é»˜è®¤èšç„¦è½®å»“ */
                details summary:focus {
                    outline: none;
                }
                
                /* è‡ªå®šä¹‰å±•å¼€å›¾æ ‡ */
                details summary::-webkit-details-marker {
                    display: none;
                }
                details summary::after {
                    content: "â–¶";
                    position: absolute;
                    right: 16px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 0.8em;
                    color: #7f8c8d;
                    transition: transform 0.2s ease;
                }
                details[open] summary::after {
                    transform: translateY(-50%) rotate(90deg);
                }
                
                /* å±•å¼€å†…å®¹åŒºåŸŸ */
                details .control-group {
                    padding: 16px;
                    background: white;
                    border-radius: 0 0 8px 8px;
                    display: grid;
                    gap: 1.2rem;
                }
                
                /* å“åº”å¼å¸ƒå±€ */
                @media (min-width: 768px) {
                    details .control-group {
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    }
                }
                
                /* è¾“å…¥ç»„æ ·å¼ */
                .input-group {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .input-group label {
                    font-size: 0.9em;
                    color: #34495e;
                    font-weight: 500;
                }
                
                .input-group input[type="number"],
                .input-group input[type="text"] {
                    padding: 8px 12px;
                    border: 1px solid #bdc3c7;
                    border-radius: 4px;
                    width: 100%;
                    max-width: 300px;
                    transition: border-color 0.2s ease;
                }
                
                .input-group input:focus {
                    border-color: #3498db;
                    outline: none;
                }
                
                /* æ»‘åŠ¨æ¡ç‰¹æ®Šæ ·å¼ */
                #speedControl {
                    padding: 8px 0;
                }
                
                #speedControl input[type="range"] {
                    width: 200px;
                    margin: 0 10px;
                    vertical-align: middle;
                }
                
                #speedValue {
                    display: inline-block;
                    min-width: 40px;
                    text-align: center;
                    font-weight: bold;
                    color: #3498db;
                }
                
                /* å¤é€‰æ¡†æ ‡ç­¾æ’ç‰ˆ */
                .input-group label[style*="cursor: pointer"] {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    user-select: none;
                }
                
                /* å±•å¼€åŠ¨ç”» */
                details[open] summary {
                    background: #f1f8ff;
                    border-bottom: 1px solid #e0e0e0;
                }
                
                @keyframes slideDown {
                    from { opacity: 0; transform: translateY(-10px) }
                    to { opacity: 1; transform: translateY(0) }
                }
                
                details[open] .control-group {
                    animation: slideDown 0.3s ease-out;
                }
            </style>            

            <div class="button-group">
                <button onclick="playSimulated()"> Random Call Sign Practice</button>
                <button onclick="playFormat1()">Number Call Sign Practice</button>
                <button onclick="playLetters()">English Letter Practice</button>
            </div>
            <div class="button-group">
                <button onclick="toggleAnswer()">
                    <span id="toggleIcon">ğŸ”</span> 
                    <span id="toggleText">Show Answer</span>
                </button>
                <button id="pauseResumeBtn" onclick="togglePauseResume()" disabled>â¸ Pause/Resume</button>
                <button id="stopBtn" onclick="stopPlayback()" disabled>â¹ Stop</button>
            </div>
            <div class="shortcut-hints-container">
                <div class="shortcut-hints">
                    <kbd>Enter</kbd>Check Answer | 
                    <kbd>Space</kbd>Pause/Resume | 
                    <kbd>R</kbd>Regenerate | 
                    <kbd>H</kbd>Hide Answer
                </div>
            </div>
            <div id="answer"></div>
        
            <div class="answer-input-group">
                <input type="text" id="userAnswer" placeholder="Enter your answer here, press Enter to check" 
                       onkeypress="if(event.key === 'Enter') checkAnswer()">
                <button onclick="checkAnswer()">âœ“ Check Answer</button>
            </div>
            <div id="answerFeedback" class="feedback"></div>
            

            <style>
                .shortcut-hints-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-top: 1rem;
                }

                .shortcut-hints {
                    font-size: 0.9rem;
                    color: var(--text-color);
                }
                
                .shortcut-hints kbd {
                    background: var(--secondary-color);
                    color: white;
                    padding: 0.2rem 0.5rem;
                    border-radius: 4px;
                    margin: 0 0.2rem;
                }
            </style>

            <style>
                :root {
                    --success-color: #27ae60;
                    --danger-color: #e74c3c;
                    --border-color: #bdc3c7;
                }
               
                .control-group {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                    gap: 1.2rem;
                    background: var(--light-blue);
                    padding: 1.5rem;
                    border-radius: 12px;
                    margin-bottom: 2rem;
                    border: 1px solid #d4e3f0;
                }
            
                .input-group {
                    display: flex;
                    flex-direction: column;
                    gap: 0.4rem;
                }
            
                label {
                    font-weight: 600;
                    font-size: 0.9rem;
                    color: var(--primary-color);
                }
            
                input[type="text"],
                input[type="number"] {
                    padding: 0.7rem;
                    border: 2px solid var(--border-color);
                    border-radius: 6px;
                    font-size: 0.95rem;
                    transition: all 0.2s ease;
                }
            
                input[type="text"]:focus,
                input[type="number"]:focus {
                    border-color: var(--secondary-color);
                    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
                    outline: none;
                }
            
                .button-group {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.8rem;
                    margin: 2rem 0;
                    justify-content: center;
                }
            
                button {
                    padding: 0.8rem 1.4rem;
                    border: none;
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.6rem;
                    background: var(--secondary-color);
                    color: white;
                }
            
                button:hover {
                    background: var(--accent-color);
                }
            
                button:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                    background: #95a5a6;
                }
            
                #stopBtn {
                    background: var(--danger-color);
                }
            
                button[onclick="toggleAnswer"] {
                    background: #7f8c8d;
                }
            
                #speedControl {
                    background: var(--light-blue);
                }
            
                input[type="range"] {
                    width: 200px;
                    height: 4px;
                    background: #dfe6e9;
                    border-radius: 2px;
                }
            
                input[type="range"]::-webkit-slider-thumb {
                    width: 16px;
                    height: 16px;
                    background: var(--secondary-color);
                }
            
                #answer {
                    display: none; /* é»˜è®¤éšè— */
                    background: var(--light-blue);
                    padding: 1.2rem;
                    border-radius: 8px;
                    font-family: 'Courier New', monospace;
                    font-size: 1.1rem;
                    border: 2px solid var(--secondary-color);
                    margin-top: 1.5rem;
                }
            
                .input-group label input[type="checkbox"] {
                    margin-right: 0.5rem;
                    accent-color: var(--secondary-color);
                }
            
                @media (max-width: 600px) {
                    body {
                        padding: 1rem;
                    }
                    
                    .button-group {
                        flex-direction: column;
                    }
                    
                    button {
                        justify-content: center;
                    }
                }
            </style>

                <!-- æ–°å¢ç­”é¢˜åŒºåŸŸæ ·å¼ -->
            <style>
                .answer-input-group {
                    display: flex;
                    gap: 0.8rem;
                    margin: 1.5rem 0;
                }

                #userAnswer {
                    flex: 1;
                    padding: 0.8rem;
                    border: 2px solid var(--border-color);
                    border-radius: 6px;
                    font-size: 1rem;
                    transition: all 0.2s ease;
                }

                #userAnswer:focus {
                    border-color: var(--secondary-color);
                    outline: none;
                }

                .feedback {
                    padding: 1rem;
                    border-radius: 8px;
                    margin: 1rem 0;
                    font-weight: 600;
                    transition: all 0.3s ease;
                }

                .feedback.correct {
                    background: var(--success-color);
                    color: white;
                }

                .feedback.incorrect {
                    background: var(--danger-color);
                    color: white;
                }
            </style>
        
            <script>
                const GOOGLE_TTS_API_KEY = 'AIzaSyB8kUi4-oUJgYZQFidBvtGsjLrS1dxw1W4'; 
                const AUS_VOICES = [
                    'en-AU-Standard-A',
                    'en-AU-Standard-B',
                    'en-AU-Standard-C',
                    'en-AU-Standard-D',
                    'en-US-Standard-A',
                    'en-US-Standard-B',
                    'en-US-Standard-C',
                    'en-US-Standard-D',
                    /*'en-AU-Wavenet-A',
                    'en-AU-Wavenet-B',
                    'en-AU-Wavenet-C',
                    'en-AU-Wavenet-D'*/
                ];
        
                const aviationMap = {
                    'A': 'Alpha', 'B': 'Bravo', 'C': 'Charlie', 'D': 'Delta',
                    'E': 'Echo', 'F': 'Foxtrot', 'G': 'Golf', 'H': 'Hotel',
                    'I': 'India', 'J': 'Juliet', 'K': 'Kilo', 'L': 'Lima',
                    'M': 'Mike', 'N': 'November', 'O': 'Oscar', 'P': 'Papa',
                    'Q': 'Quebec', 'R': 'Romeo', 'S': 'Sierra', 'T': 'Tango',
                    'U': 'Uniform', 'V': 'Victor', 'W': 'Whiskey', 'X': 'Xray',
                    'Y': 'Yankee', 'Z': 'Zulu'
                };
        
                const aircraftTypes = [
                    "Cessna","Cessna Citation", "Brumby", "Sling", "Diamond", "Saab", 
                    "Beech King Air","Beech Baron", "Embraer", "Bombardier", "Piper", "Piper warrior", "Piper Chieftain","Beechcraft", "Eclipse", "Jabiru",
                    "Gulfstream", "Cirrus", "Mooney", "Robin", "Socata", "BRM Aero",
                    "Pilatus", "Tecnam", "Extra", "Van's Aircraft", "Ambulance", "Careflight"
                ];
        
                const ultraLightAircraft = ["Brumby", "Sling", "Tecnam", "Van's Aircraft", "Van's", "BRM Aero", "Jabiru"];
                const aviationNumbers = {
                    '0': 'Zero', '1': 'One', '2': 'Two', 
                    '3': 'Tree', '4': 'Four', '5': 'Five',
                    '6': 'Six', '7': 'Seven', '8': 'Eight', 
                    '9': 'Niner'
                };

                // åœ¨å¸¸é‡åŒºæ·»åŠ æ•°å­—èŒƒå›´
                const FORMAT1_RANGES = [
                    {min: 1000, max: 9999} // ä»»æ„å››ä½æ•°
                ];
                const FORMAT2_RANGES = [
                    {min: 160, max: 174} // 160-174åŒºé—´
                ];

                let currentAnswer = {
                    type: null,     // 'letters' æˆ– 'callsigns'
                    raw: "",        // åŸå§‹ç­”æ¡ˆå­—ç¬¦ä¸²
                    elements: []    // è§£æåçš„å…ƒç´ æ•°ç»„ï¼ˆå­—æ¯æˆ–çº¯å‘¼å·ï¼‰
                };
                let currentAudio = null;

                //æ’­æ”¾æ•°å­—å‘¼å·
                function playFormat1() {
                    const callsignCount = parseInt(document.getElementById("callsignCount").value, 10);
                    let output = [];
                    let speechParts = [];
                    
                    for(let i=0; i<callsignCount; i++){
                        const number = generateNumber(FORMAT1_RANGES);
                        const [speech, formatted] = processFormat1(number);
                        
                        output.push(formatted);
                        speechParts.push(speech);
                    }
                    
                    currentAnswer = {
                        type: 'format1',
                        raw: output.join(', '),
                        elements: output
                    };
                    updateAnswer();
                    speakText(speechParts.join(', '));

                     // æ–°å¢è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                    document.getElementById('userAnswer').focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                }

                // è¾…åŠ©å‡½æ•°
                function generateNumber(ranges) {
                    const range = ranges[Math.floor(Math.random()*ranges.length)];
                    return Math.floor(Math.random()*(range.max - range.min +1)) + range.min;
                }

                function processFormat1(number) {
                    const numStr = number.toString().padStart(4, '0');
                    const part1 = numStr.substring(0, 2); // ç›´æ¥ä½¿ç”¨ä¸¤ä½å­—ç¬¦ä¸²
                    const part2 = numStr.substring(2);    // ç›´æ¥ä½¿ç”¨ä¸¤ä½å­—ç¬¦ä¸²

                    const speech1 = convertNumberGroup(part1);
                    const speech2 = convertNumberGroup(part2);

                    return [`${speech1} ${speech2}`, numStr];
                }

                // æ·»åŠ è¾…åŠ©æ˜¾ç¤ºå‡½æ•°
                function showFeedback(message, isCorrect) {
                    const feedbackDiv = document.getElementById('answerFeedback');
                    feedbackDiv.innerHTML = message;
                    feedbackDiv.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                }

                function base64ToBlob(base64Data, contentType = '', sliceSize = 512) {
                    const byteCharacters = atob(base64Data);
                    const byteArrays = [];
                    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                        const slice = byteCharacters.slice(offset, offset + sliceSize);
                        const byteNumbers = new Array(slice.length);
                        for (let i = 0; i < slice.length; i++) {
                            byteNumbers[i] = slice.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        byteArrays.push(byteArray);
                    }
                    return new Blob(byteArrays, { type: contentType });
                }
        
                function togglePauseResume() {
                    if (!currentAudio) return;
                    if (currentAudio.paused) {
                        currentAudio.play();
                    } else {
                        currentAudio.pause();
                    }
                }
        
                function stopPlayback() {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                        currentAudio = null;
                    }
                    updateButtonState();
                }
        
                function updateButtonState() {
                    const pauseResumeBtn = document.getElementById('pauseResumeBtn');
                    const stopBtn = document.getElementById('stopBtn');
                    const isPlaying = currentAudio && !currentAudio.paused;
                    
                    pauseResumeBtn.disabled = !currentAudio;
                    stopBtn.disabled = !currentAudio;
                }
        
                function generateCustomLetters() {
                    const custom = document.getElementById("customLetters").value
                        .toUpperCase().replace(/[^A-Z]/g, '');
                    return custom || "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                }
        
                // æ·»åŠ éŸ³é¢‘æ•ˆæœå¤„ç†å‡½æ•°
                async function applyRadioEffects(audioElement) {
                    const ctx = new AudioContext();
                    const src = ctx.createMediaElementSource(audioElement);
                    
                        // æ–°å¢åŸå§‹éŸ³é¢‘å¢ç›Šæ§åˆ¶
                    const sourceGain = ctx.createGain();
                    sourceGain.gain.value = 6; // é»˜è®¤åŸå§‹éŸ³é‡å¢ç›Š2å€
        
        
                    // ========== ä½é€šæ»¤æ³¢å™¨å‚æ•° ==========
                    const filter = ctx.createBiquadFilter();
                    filter.type = "lowpass";          // æ»¤æ³¢å™¨ç±»å‹
                    filter.frequency.value = 8000;   // æˆªæ­¢é¢‘ç‡ (Hz) èŒƒå›´ï¼š200-8000
                    filter.Q.value = 5;              // å…±æŒ¯å€¼ èŒƒå›´ï¼š0.0001-100
        
        
                    // åˆ›å»ºç™½å™ªå£°
                    // ========== ç™½å™ªå£°å‚æ•° ==========
                    const noiseGain = ctx.createGain();
                    noiseGain.gain.value = 0.004;     // å™ªå£°éŸ³é‡ èŒƒå›´ï¼š0.0-1.0
        
                        // ========== è¿æ¥é¡ºåºè°ƒæ•´ ==========
                    src.connect(sourceGain);      // å…ˆè¿æ¥å¢ç›Šæ§åˆ¶
                    sourceGain.connect(filter);   // å†è¿æ¥æ»¤æ³¢å™¨
                    filter.connect(ctx.destination);
        
                    const noise = (() => {
                        const bufferSize = ctx.sampleRate;
                        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < bufferSize; i++) {
                            data[i] = Math.random() * 2 - 1;
                        }
                        const noise = ctx.createBufferSource();
                        noise.buffer = buffer;
                        noise.loop = true;
                        noise.connect(noiseGain);
                        return noise;
                    })();
        
                    // åˆ›å»ºè„‰å†²å£°
                    function addBeep(time) {
                        const osc = ctx.createOscillator();
                        const gainNode = ctx.createGain();
                        osc.type = "square";         // æ³¢å½¢ç±»å‹ï¼šsine/square/sawtooth/triangle
                        osc.frequency.value = 2000;  // è„‰å†²é¢‘ç‡ (Hz) èŒƒå›´ï¼š500-3000
                        gainNode.gain.setValueAtTime(0.5, time);      // åˆå§‹éŸ³é‡
                        gainNode.gain.exponentialRampToValueAtTime(   // è¡°å‡æ›²çº¿
                            0.01,                   // æœ€ç»ˆéŸ³é‡
                            time + 0.2               // æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
                        );
                        osc.connect(gainNode);
                        gainNode.connect(ctx.destination);
                        osc.start(time);
                        osc.stop(time + 0.1);
                    }
        
                    // è¿æ¥èŠ‚ç‚¹
                    src.connect(filter);
                    filter.connect(ctx.destination);
                    noise.connect(filter);
                    
                    // æ·»åŠ å¼€å§‹/ç»“æŸè„‰å†²
                    const startTime = ctx.currentTime + 0.1;
                    addBeep(startTime);
                    audioElement.addEventListener('play', () => {
                        noise.start();
                        addBeep(startTime);
                    });
                    audioElement.addEventListener('ended', () => {
                        addBeep(ctx.currentTime);
                        noise.stop();
                    });
                    audioElement.addEventListener('pause', () => noise.stop());
                }
        
        
                async function speakText(text) {
                    const speed = parseFloat(document.getElementById('speed').value);
                    const useDiverse = document.getElementById('voiceDiversity').checked;
                    const simulateRadio = document.getElementById('simulateRadio').checked;
        
                    try {
                        const response = await fetch(
                            `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_API_KEY}`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    input: { text: text },
                                    voice: {
                                        languageCode: 'en-AU',
                                        name: useDiverse ? 
                                            AUS_VOICES[Math.floor(Math.random() * AUS_VOICES.length)] :
                                            'en-US-Standard-D' // é»˜è®¤è¯­éŸ³
                                    },
                                    audioConfig: { 
                                        audioEncoding: 'MP3', 
                                        speakingRate: speed,
                                        pitch: useDiverse ? Math.random() * 4 - 2 : 0 // éšæœºéŸ³é«˜(-2åˆ°+2)
                                    }
                                })
                            }
                        );
        
                        const data = await response.json();
                        const audioContent = data.audioContent;
                        const blob = base64ToBlob(audioContent, 'audio/mp3');
                        const url = URL.createObjectURL(blob);
        
                        if (currentAudio) {
                            currentAudio.pause();
                        }
        
                        currentAudio = new Audio(url);
        
                        if(simulateRadio) {
                            await applyRadioEffects(currentAudio);
                        }
        
                        currentAudio.addEventListener('play', updateButtonState);
                        currentAudio.addEventListener('pause', updateButtonState);
                        currentAudio.addEventListener('ended', updateButtonState);
                        currentAudio.play();
                    } catch (error) {
                        console.error('è¯­éŸ³åˆæˆå¤±è´¥:', error);
                        alert('è¯­éŸ³åˆæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥å’Œç½‘ç»œè¿æ¥');
                    }
                }
        
        
                function playLetters() {
                    const letters = generateCustomLetters();
                    const letterCount = parseInt(document.getElementById("letterCount").value, 10);
                    const randomString = Array.from({length: letterCount}, () => 
                        letters[Math.floor(Math.random() * letters.length)]
                    ).join('');
                    
                    currentAnswer = {
                        type: 'letters',
                        raw: randomString,
                        elements: [randomString]
                    };
                    
                    updateAnswer();
                    speakText(randomString.split('').map(c => aviationMap[c]).join(' '));

                     // æ–°å¢è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                     document.getElementById('userAnswer').focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                }
                
                //æ’­æ”¾æ¨¡æ‹Ÿå‘¼å·
                function playSimulated() {
                    const callsignCount = parseInt(document.getElementById("callsignCount").value, 10);
                    let output = [];
                    let speechParts = [];
                    let callsignList = [];
                    
                    for(let i=0; i<callsignCount; i++){
                        const aircraft = aircraftTypes[Math.random()*aircraftTypes.length|0];
                        let callsign, speech;
                        
                        if(ultraLightAircraft.includes(aircraft)) {
                            // ç”Ÿæˆå››ä½æ•°å‘¼å·å¹¶ç¡®ä¿ä¸¤ä½åˆ†ç»„
                            const part1 = Math.floor(Math.random()*90)+10; // 10-99
                            const part2 = Math.floor(Math.random()*90)+10;
                            callsign = part1.toString() + part2.toString().padStart(2, '0'); // å¼ºåˆ¶å››ä½æ•°
                            
                            // è°ƒç”¨ç»Ÿä¸€çš„æ•°å­—è½¬æ¢å‡½æ•°
                            speech = [
                                convertNumberGroup(part1.toString().padStart(2, '0')), // å‰ä¸¤ä½
                                convertNumberGroup(part2.toString().padStart(2, '0'))  // åä¸¤ä½
                            ].join(' ');
                        } else {
                            const isLettersOnly = Math.random() < 0.5;
                            
                            if(isLettersOnly) {
                                callsign = Array.from({length:3}, () => 
                                    String.fromCharCode(65 + Math.random()*26|0)
                                ).join('');
                                speech = callsign.split('').map(c => aviationMap[c]).join(' ');
                            } else {
                                let hasLetter = false, hasNumber = false;
                                do {
                                    callsign = '';
                                    hasLetter = false;
                                    hasNumber = false;
                                    for(let j=0; j<3; j++) {
                                        if(Math.random() < 0.5) {
                                            callsign += String.fromCharCode(65 + Math.random()*26|0);
                                            hasLetter = true;
                                        } else {
                                            callsign += Math.random()*10|0;
                                            hasNumber = true;
                                        }
                                    }
                                } while(!(hasLetter && hasNumber));
                                
                                speech = callsign.split('').map(c => {
                                    return /[A-Z]/.test(c) ? aviationMap[c] : convertSingleNumber(c);
                                }).join(' ');
                            }
                        }
                        
                        output.push(`${aircraft} ${callsign}`);
                        callsignList.push(callsign.replace(/[^A-Z0-9]/g, ''));
                        speechParts.push(`${aircraft} ${speech}`);
                    }
                    
                    currentAnswer = {
                        type: 'callsigns',
                        raw: output.join(', '),
                        elements: callsignList
                    };
                    updateAnswer();
                    speakText(speechParts.join(', '));

                     // æ–°å¢è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                    document.getElementById('userAnswer').focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                }
        
                // è¾…åŠ©å‡½æ•°ä¿æŒä¸å˜...
                function convertNumberGroup(twoDigitStr) {
                    const firstDigit = twoDigitStr[0];
                    const secondDigit = twoDigitStr[1];

                    // å¤„ç†å‰å¯¼é›¶çš„æƒ…å†µ (å¦‚ "05" -> Zero Five)
                    if (firstDigit === '0') {
                        if (secondDigit === '0') return 'Zero Zero';
                        return `Zero ${aviationNumbers[secondDigit]}`;
                    }

                    // å¤„ç†10-19çš„ç‰¹æ®Šè¯»æ³•
                    if (firstDigit === '1') {
                        const num = parseInt(twoDigitStr, 10);
                        switch(num) {
                            case 10: return 'Ten';
                            case 11: return 'Eleven';
                            case 12: return 'Twelve';
                            case 13: return 'Thirteen';
                            case 14: return 'Fourteen';
                            case 15: return 'Fifteen';
                            case 16: return 'Sixteen';
                            case 17: return 'Seventeen';
                            case 18: return 'Eighteen';
                            case 19: return 'Nineteen';
                        }
                    }

                    // å¤„ç†20-99çš„è¯»æ³•
                    let tenPart = aviationNumbers[firstDigit]
                        .replace('Two', 'Twenty')
                        .replace('Tree', 'Thirty')
                        .replace('Four', 'Forty')
                        .replace('Five', 'Fifty')
                        .replace('Six', 'Sixty')
                        .replace('Seven', 'Seventy')
                        .replace('Eight', 'Eighty')
                        .replace('Niner', 'Ninety');

                    if (secondDigit === '0') {
                        return tenPart; // æ•´åæ•°å¦‚30 -> Thirty
                    } else {
                        return `${tenPart} ${aviationNumbers[secondDigit]}`; // éæ•´åæ•°å¦‚34 -> Thirty Four
                    }
                }

                function convertSingleNumber(numChar) {
                    return aviationNumbers[numChar];
                }
        
                // ä¿®æ”¹ç­”æ¡ˆæ˜¾ç¤ºé€»è¾‘
                function updateAnswer() {
                    const div = document.getElementById('answer');
                    div.textContent = currentAnswer.raw;
                    document.getElementById('userAnswer').value = '';
                    document.getElementById('answerFeedback').textContent = '';
                    document.getElementById('answerFeedback').className = 'feedback';
                }

                function updateSpeed(v) {
                    document.getElementById('speedValue').textContent = v;
                }
        
                function toggleAnswer() {
                    const div = document.getElementById('answer');
                    const icon = document.getElementById('toggleIcon');
                    const text = document.getElementById('toggleText');
                    
                    if(div.style.display === 'none') {
                        div.style.display = 'block';
                        icon.textContent = 'ğŸ‘ï¸';
                        text.textContent = 'Hide Answer';
                    } else {
                        div.style.display = 'none';
                        icon.textContent = 'ğŸ”';
                        text.textContent = 'Show Answer';
                    }
                }
        
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden) {
                        stopPlayback();
                    }
                });
            
                // æ”¹è¿›çš„ç­”æ¡ˆæ ¸å¯¹å‡½æ•°
                function checkAnswer() {
                    const cleanInput = (str) => str.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    const userInput = document.getElementById('userAnswer').value;
                    const feedbackDiv = document.getElementById('answerFeedback');
                    
                    // æ¸…ç©ºåé¦ˆæ ·å¼
                    feedbackDiv.className = 'feedback';
                    feedbackDiv.innerHTML = '';

                    // å¤„ç†å‘¼å·æ¨¡å¼
                    if(currentAnswer.type === 'callsigns') {
                        // æ‹†åˆ†ç”¨æˆ·è¾“å…¥ä¸ºå¤šä¸ªå‘¼å·ï¼ˆå…è®¸ä»»æ„åˆ†éš”ç¬¦ï¼‰
                        const userCallsigns = userInput.split(/[^a-zA-Z0-9]+/)
                            .filter(Boolean)
                            .map(cleanInput);

                        // Answer validation logic
                        const expected = currentAnswer.elements;
                        let errorDetails = [];
                        
                        // Check for matching count
                        if(userCallsigns.length !== expected.length) {
                            feedbackDiv.innerHTML = `
                                <div class="error-header">âš  Expected ${expected.length} call signs, but you entered ${userCallsigns.length}</div>
                                <div class="correct-all">Correct Answer: ${expected.join(', ')}</div>
                            `;
                            feedbackDiv.className += ' incorrect';

                            // Remove focus from input field after submission
                            document.getElementById('userAnswer').blur();

                            return;
                        }

                        // Compare each call sign and record errors
                        expected.forEach((correct, index) => {
                            const userAnswer = userCallsigns[index];
                            if(userAnswer !== correct) {
                                errorDetails.push({
                                    position: index + 1,
                                    user: userAnswer || "[Empty Input]",
                                    correct: correct
                                });
                            }
                        });

                        // Build feedback message
                        if(errorDetails.length === 0) {
                            feedbackDiv.innerHTML = 'âœ… All call signs are correct!';
                            feedbackDiv.className += ' correct';
                        } else {
                            let errorList = errorDetails.map(err => 
                                `- Call sign ${err.position} is incorrect: Expected <span class="correct-highlight">${err.correct}</span>, but you entered <span class="user-error">${err.user}</span>`
                            ).join('<br>');

                            feedbackDiv.innerHTML = `
                                <div class="error-header">âš  Found ${errorDetails.length} errors:</div>
                                <div class="error-details">${errorList}</div>
                                <div class="correct-all">Correct Answer: ${expected.join(', ')}</div>
                            `;
                            feedbackDiv.className += ' incorrect';
                        }
                    }
                    // Letter mode retains original logic
                    else if(currentAnswer.type === 'letters') {
                        const userClean = cleanInput(userInput);
                        const correctClean = cleanInput(currentAnswer.raw);
                        
                        if(userClean === correctClean) {
                            feedbackDiv.textContent = 'âœ… Correct Answer!';
                            feedbackDiv.className += ' correct';
                        } else {
                            feedbackDiv.textContent = `âš  Incorrect Answer, Correct Answer: ${currentAnswer.raw}`;
                            feedbackDiv.className += ' incorrect';
                        }
                    }
                    // Add logic for format-based answers
                    else if(currentAnswer.type.startsWith('format')) {
                        const cleanInput = (str) => str.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        const userAnswers = userInput.split(/[^a-zA-Z0-9]+/)
                            .filter(Boolean)
                            .map(s => currentAnswer.type === 'format2' ? 
                                s.replace(/D$/i, '') + 'D' : // Standardize D suffix
                                s.padStart(4, '0').substring(0,4));
                        
                        const expected = currentAnswer.elements;
                        let errors = [];
                        
                        if(userAnswers.length !== expected.length) {
                            showFeedback(`âš  Expected ${expected.length} call signs, but you entered ${userAnswers.length}`, false);

                            // Remove focus from input field after submission
                            document.getElementById('userAnswer').blur();

                            return;
                        }
                        
                        userAnswers.forEach((answer, i) => {
                            const cleanAnswer = cleanInput(answer);
                            const cleanExpected = cleanInput(expected[i]);
                            if(cleanAnswer !== cleanExpected) errors.push(`âš  Call sign ${i+1} is incorrect, expected ${expected[i]}`);
                        });
                        
                        if(errors.length > 0) {
                            showFeedback(errors.join('<br>') + `<br>Correct Answer: ${expected.join(', ')}`, false);
                        } else {
                            showFeedback('âœ… All call signs are correct!', true);
                        }
                    }

                    // æ–°å¢ï¼šæäº¤ç­”æ¡ˆåï¼Œç§»é™¤è¾“å…¥æ¡†ç„¦ç‚¹
                    document.getElementById('userAnswer').blur(); // æ–°å¢ï¼šç§»é™¤è¾“å…¥æ¡†ç„¦ç‚¹
                }
            
                // æ·»åŠ è¾…åŠ©æ˜¾ç¤ºå‡½æ•°
                function showFeedback(message, isCorrect) {
                    const feedbackDiv = document.getElementById('answerFeedback');
                    feedbackDiv.innerHTML = message;
                    feedbackDiv.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                }
                
                // åœ¨è„šæœ¬æœ«å°¾æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
                document.addEventListener('keydown', handleKeyboardShortcuts);

                // é”®ç›˜å¤„ç†å‡½æ•°
                function handleKeyboardShortcuts(event) {
                    const activeTag = document.activeElement.tagName.toLowerCase();
                    
                    // æ’é™¤è¾“å…¥æ¡†èšç„¦çŠ¶æ€
                    if (activeTag === 'input' || activeTag === 'textarea') return;

                    switch(event.key.toLowerCase()) {
                        case ' ': // ç©ºæ ¼é”®ï¼šæ’­æ”¾/æš‚åœ
                            event.preventDefault();
                            togglePauseResume();
                            break;
                            
                        case 'enter': // å›è½¦é”®ï¼šæäº¤ç­”æ¡ˆ
                            event.preventDefault();
                            checkAnswer();
                            break;
                            
                        case 'arrowleft': // å·¦ç®­å¤´ï¼šå‡æ…¢è¯­é€Ÿ
                            adjustSpeed(-0.1);
                            break;
                            
                        case 'arrowright': // å³ç®­å¤´ï¼šåŠ å¿«è¯­é€Ÿ
                            adjustSpeed(0.1);
                            break;
                            
                        case 'r': // Ré”®ï¼šé‡æ–°ç”Ÿæˆé¢˜ç›®
                            if(event.ctrlKey) break; // é¿å…ä¸æµè§ˆå™¨åˆ·æ–°å†²çª
                            event.preventDefault();
                            if(currentAnswer.type === 'callsigns') playSimulated();
                            else if(currentAnswer.type === 'letters') playLetters();
                            break;
                            
                        case 'h': // Hé”®ï¼šæ˜¾ç¤º/éšè—ç­”æ¡ˆ
                            event.preventDefault();
                            toggleAnswer();
                            break;
                    }
                }

            
            </script>
        </section>
    </main>

    <footer>
        <div class="footer-content">
          <p>Â© 2025 Yohann's Flight Notes. All rights reserved.</p>
          <p>
            This project is open source under the <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank">GNU AGPLv3 license</a>,
            for non-commercial use only. Cited content has been marked, infringement please contact <a href="yuhan_zhao@nuaa.edu.cn">Email</a>.
          </p>
        </div>
    </footer>
</body>
</html>