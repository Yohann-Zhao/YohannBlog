<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>陆空通话 | 航空英语 | Yohann飞行笔记</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G3TQJTQ67B"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-G3TQJTQ67B');
    </script>


    <link rel="icon" type="image/x-icon" href="yohann_favicon.ico">
</head>

<style>
    /* 新增样式：导航路径样式 */
    .breadcrumb {
        padding: 1rem;
        padding-left: 10%;
        background: var(--background-color);
        box-shadow: var(--shadow-sm);
    }

    .breadcrumb a {
        text-decoration: none;
        color: var(--text-color);
        font-size: 1rem;
        transition: var(--transition);
    }

        .breadcrumb a:hover {
            color: var(--primary-color);
        }

    .breadcrumb span {
        color: var(--text-color);
        font-size: 0.9rem;
        margin: 0 0.5rem;
    }
</style>

<style>
.nav-breadcrumb-container {
    position: -webkit-sticky; /* Safari */
    position: sticky;
    top: 0;
    background-color:; /* 可选：设置背景颜色 */
    z-index: 1000; /* 确保它在其他内容之上 */
}

</style>
<body>

    <header>
        <div class="language-switcher">
            <a href="Radio_Call_Practice.html">中文</a> | <a href="Radio_Call_Practice_en.html">English</a>
        </div>
        <div class="header-content">
            <h1>陆空通话</h1>
        </div>
    </header>

    <div class="nav-breadcrumb-container">
        <nav>
            <ul>
                <li><a href="index.html">主页</a></li>
                <li><a href="theory.html">理论考试</a></li>
                <li><a href="flight-training.html">飞行训练</a></li>
                <li><a href="aviation-english.html" class="active">航空英语</a></li>
                <li><a href="about.html">关于我</a></li>
            </ul>
        </nav>

        <!-- 导航路径 -->
        <div class="breadcrumb">
            <a href="aviation-english.html">所有板块</a>
            <span>></span>
            <a id="subject-name">陆空通话</a>
        </div>
        
    </div>

    <main class="container">
        <section id="radio call into" class="text-section">
            <h2>基本呼号读法</h2>
            <p>呼号是飞机的标识，由字母和数字组成。</p>
            <h3>发音规则</h3>
                <li>字母：A（Alpha）、B（Bravo）、C（Charlie）、D（Delta）、E（Echo）、F（Foxtrot）、G（Golf）、H（Hotel）、I（India）、J（Juliet）、K（Kilo）、L（Lima）、M（Mike）、N（November）、O（Oscar）、P（Papa）、Q（Quebec）、R（Romeo）、S（Sierra）、T（Tango）、U（Uniform）、V（Victor）、W（Whiskey）、X（X-ray）、Y（Yankee）、Z（Zulu）</li>
                <li>数字：3（Tree）、9（Niner）; 呼号中的数字两两为一组</li>
            <h3>发音示例</h3>
                <li>AI9: "Alpha India Niner"、8470: "Eighty Four Seventy"、172D: "One Seventy Two Delta"</li>

                <style>
                    .section {
                        padding: 3em;
                    }
                    
                    .section h2 {
                        font-size: 1.8em;
                        margin-bottom: 0.5em;
                        border-bottom: 2.5px solid var(--primary-color);
                        padding-bottom: 0.2em;
                    }
                    
                    .section h3 {
                        font-size: 1.4em;
                        margin-top: 1em;
                        margin-bottom: 0.5em;
                        color: #333;
                    }
                    
                    .section h4 {
                        font-size: 1.1em;
                        margin-top: 0.8em;
                        margin-bottom: 0.4em;
                        color: var(--primary-color);
                    }
                    
                    .section ul {
                        list-style-type: disc;
                        margin-left: 1.5em;
                        margin-bottom: 1em;
                    }
                    
                    .section ul li {
                        margin-bottom: 0.5em;
                    }
                    
                    .section p {
                        margin-bottom: 1em;
                        line-height: 1.6;
                    }
                    </style>
        </section>

        <section id="Real_AU_callsign_reader" class="text-section">
            <h2>呼号听写练习</h2>
            <h3>使用说明</h3>
            <h4>呼号练习模式</h4>
            <p>点击"模拟呼号"按钮，播放模拟交通的“机型”和“呼号”。练习正确识别并听写“呼号”（仅写下呼号）。</p>
            <h4>字母练习模式</h4>
            <p>点击“字母练习”，练习字母听写；您可自定义需要练习的字母，例如XYZR，默认为A-Z；</p>
            <details>
                <summary>更多选项</summary>
                <div class="control-group">
                    <div class="input-group">
                        <label>每组呼号数量：</label>
                        <input type="number" id="callsignCount" value="1" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label>自定义字母：</label>
                        <input type="text" id="customLetters" maxlength="26" placeholder="字母专练：例如XYZR，默认A-Z">
                    </div>
                    <div class="input-group">
                        <label>每组字母数量：</label>
                        <input type="number" id="letterCount" value="9" min="1" max="50">
                    </div>
                </div>
                <div class="control-group">
                    <div id="speedControl">
                        <label>语速调整
                            <input type="range" id="speed" min="0.3" max="2" value="1.2" step="0.1" oninput="updateSpeed(this.value)">
                            <span id="speedValue">1.2</span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label style="cursor: pointer;">
                            多样化人声（澳大利亚）<input type="checkbox" id="voiceDiversity">
                        </label>
                    </div>
                    <div class="input-group">
                        <label style="cursor: pointer;">
                            模拟无线电音色 <input type="checkbox" id="simulateRadio"> 
                        </label>
                    </div>
                </div>
            </details>
 
            <style>
                /* 基础折叠面板样式 */
                details {
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    margin: 1rem 0;
                    transition: all 0.3s ease;
                }
                
                /* 鼠标悬停效果 */
                details:hover {
                    border-color: #3498db;
                    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
                }
                
                /* 标题样式 */
                details summary {
                    padding: 12px 16px;
                    background: #f8f9fa;
                    color: #2c3e50;
                    font-weight: 500;
                    cursor: pointer;
                    list-style: none; /* 隐藏默认箭头 */
                    border-radius: 8px 8px 0 0;
                    position: relative;
                    transition: background 0.2s ease;
                }
                
                /* 移除默认聚焦轮廓 */
                details summary:focus {
                    outline: none;
                }
                
                /* 自定义展开图标 */
                details summary::-webkit-details-marker {
                    display: none;
                }
                details summary::after {
                    content: "▶";
                    position: absolute;
                    right: 16px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 0.8em;
                    color: #7f8c8d;
                    transition: transform 0.2s ease;
                }
                details[open] summary::after {
                    transform: translateY(-50%) rotate(90deg);
                }
                
                /* 展开内容区域 */
                details .control-group {
                    padding: 16px;
                    background: white;
                    border-radius: 0 0 8px 8px;
                    display: grid;
                    gap: 1.2rem;
                }
                
                /* 响应式布局 */
                @media (min-width: 768px) {
                    details .control-group {
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    }
                }
                
                /* 输入组样式 */
                .input-group {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .input-group label {
                    font-size: 0.9em;
                    color: #34495e;
                    font-weight: 500;
                }
                
                .input-group input[type="number"],
                .input-group input[type="text"] {
                    padding: 8px 12px;
                    border: 1px solid #bdc3c7;
                    border-radius: 4px;
                    width: 100%;
                    max-width: 300px;
                    transition: border-color 0.2s ease;
                }
                
                .input-group input:focus {
                    border-color: #3498db;
                    outline: none;
                }
                
                /* 滑动条特殊样式 */
                #speedControl {
                    padding: 8px 0;
                }
                
                #speedControl input[type="range"] {
                    width: 200px;
                    margin: 0 10px;
                    vertical-align: middle;
                }
                
                #speedValue {
                    display: inline-block;
                    min-width: 40px;
                    text-align: center;
                    font-weight: bold;
                    color: #3498db;
                }
                
                /* 复选框标签排版 */
                .input-group label[style*="cursor: pointer"] {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    user-select: none;
                }
                
                /* 展开动画 */
                details[open] summary {
                    background: #f1f8ff;
                    border-bottom: 1px solid #e0e0e0;
                }
                
                @keyframes slideDown {
                    from { opacity: 0; transform: translateY(-10px) }
                    to { opacity: 1; transform: translateY(0) }
                }
                
                details[open] .control-group {
                    animation: slideDown 0.3s ease-out;
                }
            </style>            

            <div class="button-group">
                <button onclick="playSimulated()"> 随机呼号练习</button>
                <button onclick="playFormat1()">数字呼号练习</button>
                <button onclick="playLetters()">英文字母练习</button>
            </div>
            <div class="button-group">
                <button onclick="toggleAnswer()">
                    <span id="toggleIcon">🔍</span> 
                    <span id="toggleText">显示答案</span>
                </button>
                <button id="pauseResumeBtn" onclick="togglePauseResume()" disabled>⏸ 暂停/重放</button>
                <button id="stopBtn" onclick="stopPlayback()" disabled>⏹ 停止</button>
            </div>
            <div class="shortcut-hints-container">
                <div class="shortcut-hints">
                    <kbd>回车</kbd>核对答案 | 
                    <kbd>空格</kbd>暂停/重放 | 
                    <kbd>R</kbd>重新生成 | 
                    <kbd>H</kbd>隐藏答案
                </div>
            </div>
            <div id="answer"></div>
        
            <div class="answer-input-group">
                <input type="text" id="userAnswer" placeholder="在此输入你的答案, 回车键核对" 
                       onkeypress="if(event.key === 'Enter') checkAnswer()">
                <button onclick="checkAnswer()">✓ 核对答案</button>
            </div>
            <div id="answerFeedback" class="feedback"></div>
            

            <style>
                .shortcut-hints-container {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-top: 1rem;
                }

                .shortcut-hints {
                    font-size: 0.9rem;
                    color: var(--text-color);
                }
                
                .shortcut-hints kbd {
                    background: var(--secondary-color);
                    color: white;
                    padding: 0.2rem 0.5rem;
                    border-radius: 4px;
                    margin: 0 0.2rem;
                }
            </style>

            <style>
                :root {
                    --success-color: #27ae60;
                    --danger-color: #e74c3c;
                    --border-color: #bdc3c7;
                }
               
                .control-group {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                    gap: 1.2rem;
                    background: var(--light-blue);
                    padding: 1.5rem;
                    border-radius: 12px;
                    margin-bottom: 2rem;
                    border: 1px solid #d4e3f0;
                }
            
                .input-group {
                    display: flex;
                    flex-direction: column;
                    gap: 0.4rem;
                }
            
                label {
                    font-weight: 600;
                    font-size: 0.9rem;
                    color: var(--primary-color);
                }
            
                input[type="text"],
                input[type="number"] {
                    padding: 0.7rem;
                    border: 2px solid var(--border-color);
                    border-radius: 6px;
                    font-size: 0.95rem;
                    transition: all 0.2s ease;
                }
            
                input[type="text"]:focus,
                input[type="number"]:focus {
                    border-color: var(--secondary-color);
                    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
                    outline: none;
                }
            
                .button-group {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.8rem;
                    margin: 2rem 0;
                    justify-content: center;
                }
            
                button {
                    padding: 0.8rem 1.4rem;
                    border: none;
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.6rem;
                    background: var(--secondary-color);
                    color: white;
                }
            
                button:hover {
                    background: var(--accent-color);
                }
            
                button:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                    background: #95a5a6;
                }
            
                #stopBtn {
                    background: var(--danger-color);
                }
            
                button[onclick="toggleAnswer"] {
                    background: #7f8c8d;
                }
            
                #speedControl {
                    background: var(--light-blue);
                }
            
                input[type="range"] {
                    width: 200px;
                    height: 4px;
                    background: #dfe6e9;
                    border-radius: 2px;
                }
            
                input[type="range"]::-webkit-slider-thumb {
                    width: 16px;
                    height: 16px;
                    background: var(--secondary-color);
                }
            
                #answer {
                    display: none; /* 默认隐藏 */
                    background: var(--light-blue);
                    padding: 1.2rem;
                    border-radius: 8px;
                    font-family: 'Courier New', monospace;
                    font-size: 1.1rem;
                    border: 2px solid var(--secondary-color);
                    margin-top: 1.5rem;
                }
            
                .input-group label input[type="checkbox"] {
                    margin-right: 0.5rem;
                    accent-color: var(--secondary-color);
                }
            
                @media (max-width: 600px) {
                    body {
                        padding: 1rem;
                    }
                    
                    .button-group {
                        flex-direction: column;
                    }
                    
                    button {
                        justify-content: center;
                    }
                }
            </style>

                <!-- 新增答题区域样式 -->
            <style>
                .answer-input-group {
                    display: flex;
                    gap: 0.8rem;
                    margin: 1.5rem 0;
                }

                #userAnswer {
                    flex: 1;
                    padding: 0.8rem;
                    border: 2px solid var(--border-color);
                    border-radius: 6px;
                    font-size: 1rem;
                    transition: all 0.2s ease;
                }

                #userAnswer:focus {
                    border-color: var(--secondary-color);
                    outline: none;
                }

                .feedback {
                    padding: 1rem;
                    border-radius: 8px;
                    margin: 1rem 0;
                    font-weight: 600;
                    transition: all 0.3s ease;
                }

                .feedback.correct {
                    background: var(--success-color);
                    color: white;
                }

                .feedback.incorrect {
                    background: var(--danger-color);
                    color: white;
                }
            </style>
        
            <script>
                const GOOGLE_TTS_API_KEY = 'AIzaSyB8kUi4-oUJgYZQFidBvtGsjLrS1dxw1W4'; 
                const AUS_VOICES = [
                    'en-AU-Standard-A',
                    'en-AU-Standard-B',
                    'en-AU-Standard-C',
                    'en-AU-Standard-D',
                    'en-US-Standard-A',
                    'en-US-Standard-B',
                    'en-US-Standard-C',
                    'en-US-Standard-D',
                    /*'en-AU-Wavenet-A',
                    'en-AU-Wavenet-B',
                    'en-AU-Wavenet-C',
                    'en-AU-Wavenet-D'*/
                ];
        
                const aviationMap = {
                    'A': 'Alpha', 'B': 'Bravo', 'C': 'Charlie', 'D': 'Delta',
                    'E': 'Echo', 'F': 'Foxtrot', 'G': 'Golf', 'H': 'Hotel',
                    'I': 'India', 'J': 'Juliet', 'K': 'Kilo', 'L': 'Lima',
                    'M': 'Mike', 'N': 'November', 'O': 'Oscar', 'P': 'Papa',
                    'Q': 'Quebec', 'R': 'Romeo', 'S': 'Sierra', 'T': 'Tango',
                    'U': 'Uniform', 'V': 'Victor', 'W': 'Whiskey', 'X': 'Xray',
                    'Y': 'Yankee', 'Z': 'Zulu'
                };
        
                const aircraftTypes = [
                    "Cessna","Cessna Citation", "Brumby", "Sling", "Diamond", "Saab", 
                    "Beech King Air","Beech Baron", "Embraer", "Bombardier", "Piper", "Piper warrior", "Piper Chieftain","Beechcraft", "Eclipse", "Jabiru",
                    "Gulfstream", "Cirrus", "Mooney", "Robin", "Socata", "BRM Aero",
                    "Pilatus", "Tecnam", "Extra", "Van's Aircraft", "Ambulance", "Careflight"
                ];
        
                const ultraLightAircraft = ["Brumby", "Sling", "Tecnam", "Van's Aircraft", "Van's", "BRM Aero", "Jabiru"];
                const aviationNumbers = {
                    '0': 'Zero', '1': 'One', '2': 'Two', 
                    '3': 'Tree', '4': 'Four', '5': 'Five',
                    '6': 'Six', '7': 'Seven', '8': 'Eight', 
                    '9': 'Niner'
                };

                // 在常量区添加数字范围
                const FORMAT1_RANGES = [
                    {min: 1000, max: 9999} // 任意四位数
                ];
                const FORMAT2_RANGES = [
                    {min: 160, max: 174} // 160-174区间
                ];

                let currentAnswer = {
                    type: null,     // 'letters' 或 'callsigns'
                    raw: "",        // 原始答案字符串
                    elements: []    // 解析后的元素数组（字母或纯呼号）
                };
                let currentAudio = null;

                //播放数字呼号
                function playFormat1() {
                    const callsignCount = parseInt(document.getElementById("callsignCount").value, 10);
                    let output = [];
                    let speechParts = [];
                    
                    for(let i=0; i<callsignCount; i++){
                        const number = generateNumber(FORMAT1_RANGES);
                        const [speech, formatted] = processFormat1(number);
                        
                        output.push(formatted);
                        speechParts.push(speech);
                    }
                    
                    currentAnswer = {
                        type: 'format1',
                        raw: output.join(', '),
                        elements: output
                    };
                    updateAnswer();
                    speakText(speechParts.join(', '));

                     // 新增自动聚焦到输入框
                    document.getElementById('userAnswer').focus(); // 自动聚焦到输入框
                }

                // 辅助函数
                function generateNumber(ranges) {
                    const range = ranges[Math.floor(Math.random()*ranges.length)];
                    return Math.floor(Math.random()*(range.max - range.min +1)) + range.min;
                }

                function processFormat1(number) {
                    const numStr = number.toString().padStart(4, '0');
                    const part1 = numStr.substring(0, 2); // 直接使用两位字符串
                    const part2 = numStr.substring(2);    // 直接使用两位字符串

                    const speech1 = convertNumberGroup(part1);
                    const speech2 = convertNumberGroup(part2);

                    return [`${speech1} ${speech2}`, numStr];
                }

                // 添加辅助显示函数
                function showFeedback(message, isCorrect) {
                    const feedbackDiv = document.getElementById('answerFeedback');
                    feedbackDiv.innerHTML = message;
                    feedbackDiv.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                }

                function base64ToBlob(base64Data, contentType = '', sliceSize = 512) {
                    const byteCharacters = atob(base64Data);
                    const byteArrays = [];
                    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                        const slice = byteCharacters.slice(offset, offset + sliceSize);
                        const byteNumbers = new Array(slice.length);
                        for (let i = 0; i < slice.length; i++) {
                            byteNumbers[i] = slice.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        byteArrays.push(byteArray);
                    }
                    return new Blob(byteArrays, { type: contentType });
                }
        
                function togglePauseResume() {
                    if (!currentAudio) return;
                    if (currentAudio.paused) {
                        currentAudio.play();
                    } else {
                        currentAudio.pause();
                    }
                }
        
                function stopPlayback() {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                        currentAudio = null;
                    }
                    updateButtonState();
                }
        
                function updateButtonState() {
                    const pauseResumeBtn = document.getElementById('pauseResumeBtn');
                    const stopBtn = document.getElementById('stopBtn');
                    const isPlaying = currentAudio && !currentAudio.paused;
                    
                    pauseResumeBtn.disabled = !currentAudio;
                    stopBtn.disabled = !currentAudio;
                }
        
                function generateCustomLetters() {
                    const custom = document.getElementById("customLetters").value
                        .toUpperCase().replace(/[^A-Z]/g, '');
                    return custom || "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                }
        
                // 添加音频效果处理函数
                async function applyRadioEffects(audioElement) {
                    const ctx = new AudioContext();
                    const src = ctx.createMediaElementSource(audioElement);
                    
                        // 新增原始音频增益控制
                    const sourceGain = ctx.createGain();
                    sourceGain.gain.value = 6; // 默认原始音量增益2倍
        
        
                    // ========== 低通滤波器参数 ==========
                    const filter = ctx.createBiquadFilter();
                    filter.type = "lowpass";          // 滤波器类型
                    filter.frequency.value = 8000;   // 截止频率 (Hz) 范围：200-8000
                    filter.Q.value = 5;              // 共振值 范围：0.0001-100
        
        
                    // 创建白噪声
                    // ========== 白噪声参数 ==========
                    const noiseGain = ctx.createGain();
                    noiseGain.gain.value = 0.004;     // 噪声音量 范围：0.0-1.0
        
                        // ========== 连接顺序调整 ==========
                    src.connect(sourceGain);      // 先连接增益控制
                    sourceGain.connect(filter);   // 再连接滤波器
                    filter.connect(ctx.destination);
        
                    const noise = (() => {
                        const bufferSize = ctx.sampleRate;
                        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < bufferSize; i++) {
                            data[i] = Math.random() * 2 - 1;
                        }
                        const noise = ctx.createBufferSource();
                        noise.buffer = buffer;
                        noise.loop = true;
                        noise.connect(noiseGain);
                        return noise;
                    })();
        
                    // 创建脉冲声
                    function addBeep(time) {
                        const osc = ctx.createOscillator();
                        const gainNode = ctx.createGain();
                        osc.type = "square";         // 波形类型：sine/square/sawtooth/triangle
                        osc.frequency.value = 2000;  // 脉冲频率 (Hz) 范围：500-3000
                        gainNode.gain.setValueAtTime(0.5, time);      // 初始音量
                        gainNode.gain.exponentialRampToValueAtTime(   // 衰减曲线
                            0.01,                   // 最终音量
                            time + 0.2               // 持续时间（秒）
                        );
                        osc.connect(gainNode);
                        gainNode.connect(ctx.destination);
                        osc.start(time);
                        osc.stop(time + 0.1);
                    }
        
                    // 连接节点
                    src.connect(filter);
                    filter.connect(ctx.destination);
                    noise.connect(filter);
                    
                    // 添加开始/结束脉冲
                    const startTime = ctx.currentTime + 0.1;
                    addBeep(startTime);
                    audioElement.addEventListener('play', () => {
                        noise.start();
                        addBeep(startTime);
                    });
                    audioElement.addEventListener('ended', () => {
                        addBeep(ctx.currentTime);
                        noise.stop();
                    });
                    audioElement.addEventListener('pause', () => noise.stop());
                }
        
        
                async function speakText(text) {
                    const speed = parseFloat(document.getElementById('speed').value);
                    const useDiverse = document.getElementById('voiceDiversity').checked;
                    const simulateRadio = document.getElementById('simulateRadio').checked;
        
                    try {
                        const response = await fetch(
                            `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_API_KEY}`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    input: { text: text },
                                    voice: {
                                        languageCode: 'en-AU',
                                        name: useDiverse ? 
                                            AUS_VOICES[Math.floor(Math.random() * AUS_VOICES.length)] :
                                            'en-US-Standard-D' // 默认语音
                                    },
                                    audioConfig: { 
                                        audioEncoding: 'MP3', 
                                        speakingRate: speed,
                                        pitch: useDiverse ? Math.random() * 4 - 2 : 0 // 随机音高(-2到+2)
                                    }
                                })
                            }
                        );
        
                        const data = await response.json();
                        const audioContent = data.audioContent;
                        const blob = base64ToBlob(audioContent, 'audio/mp3');
                        const url = URL.createObjectURL(blob);
        
                        if (currentAudio) {
                            currentAudio.pause();
                        }
        
                        currentAudio = new Audio(url);
        
                        if(simulateRadio) {
                            await applyRadioEffects(currentAudio);
                        }
        
                        currentAudio.addEventListener('play', updateButtonState);
                        currentAudio.addEventListener('pause', updateButtonState);
                        currentAudio.addEventListener('ended', updateButtonState);
                        currentAudio.play();
                    } catch (error) {
                        console.error('语音合成失败:', error);
                        alert('语音合成失败，请检查API密钥和网络连接');
                    }
                }
        
        
                function playLetters() {
                    const letters = generateCustomLetters();
                    const letterCount = parseInt(document.getElementById("letterCount").value, 10);
                    const randomString = Array.from({length: letterCount}, () => 
                        letters[Math.floor(Math.random() * letters.length)]
                    ).join('');
                    
                    currentAnswer = {
                        type: 'letters',
                        raw: randomString,
                        elements: [randomString]
                    };
                    
                    updateAnswer();
                    speakText(randomString.split('').map(c => aviationMap[c]).join(' '));

                     // 新增自动聚焦到输入框
                     document.getElementById('userAnswer').focus(); // 自动聚焦到输入框
                }
                
                //播放模拟呼号
                function playSimulated() {
                    const callsignCount = parseInt(document.getElementById("callsignCount").value, 10);
                    let output = [];
                    let speechParts = [];
                    let callsignList = [];
                    
                    for(let i=0; i<callsignCount; i++){
                        const aircraft = aircraftTypes[Math.random()*aircraftTypes.length|0];
                        let callsign, speech;
                        
                        if(ultraLightAircraft.includes(aircraft)) {
                            // 生成四位数呼号并确保两位分组
                            const part1 = Math.floor(Math.random()*90)+10; // 10-99
                            const part2 = Math.floor(Math.random()*90)+10;
                            callsign = part1.toString() + part2.toString().padStart(2, '0'); // 强制四位数
                            
                            // 调用统一的数字转换函数
                            speech = [
                                convertNumberGroup(part1.toString().padStart(2, '0')), // 前两位
                                convertNumberGroup(part2.toString().padStart(2, '0'))  // 后两位
                            ].join(' ');
                        } else {
                            const isLettersOnly = Math.random() < 0.5;
                            
                            if(isLettersOnly) {
                                callsign = Array.from({length:3}, () => 
                                    String.fromCharCode(65 + Math.random()*26|0)
                                ).join('');
                                speech = callsign.split('').map(c => aviationMap[c]).join(' ');
                            } else {
                                let hasLetter = false, hasNumber = false;
                                do {
                                    callsign = '';
                                    hasLetter = false;
                                    hasNumber = false;
                                    for(let j=0; j<3; j++) {
                                        if(Math.random() < 0.5) {
                                            callsign += String.fromCharCode(65 + Math.random()*26|0);
                                            hasLetter = true;
                                        } else {
                                            callsign += Math.random()*10|0;
                                            hasNumber = true;
                                        }
                                    }
                                } while(!(hasLetter && hasNumber));
                                
                                speech = callsign.split('').map(c => {
                                    return /[A-Z]/.test(c) ? aviationMap[c] : convertSingleNumber(c);
                                }).join(' ');
                            }
                        }
                        
                        output.push(`${aircraft} ${callsign}`);
                        callsignList.push(callsign.replace(/[^A-Z0-9]/g, ''));
                        speechParts.push(`${aircraft} ${speech}`);
                    }
                    
                    currentAnswer = {
                        type: 'callsigns',
                        raw: output.join(', '),
                        elements: callsignList
                    };
                    updateAnswer();
                    speakText(speechParts.join(', '));

                     // 新增自动聚焦到输入框
                    document.getElementById('userAnswer').focus(); // 自动聚焦到输入框
                }
        
                // 辅助函数保持不变...
                function convertNumberGroup(twoDigitStr) {
                    const firstDigit = twoDigitStr[0];
                    const secondDigit = twoDigitStr[1];

                    // 处理前导零的情况 (如 "05" -> Zero Five)
                    if (firstDigit === '0') {
                        if (secondDigit === '0') return 'Zero Zero';
                        return `Zero ${aviationNumbers[secondDigit]}`;
                    }

                    // 处理10-19的特殊读法
                    if (firstDigit === '1') {
                        const num = parseInt(twoDigitStr, 10);
                        switch(num) {
                            case 10: return 'Ten';
                            case 11: return 'Eleven';
                            case 12: return 'Twelve';
                            case 13: return 'Thirteen';
                            case 14: return 'Fourteen';
                            case 15: return 'Fifteen';
                            case 16: return 'Sixteen';
                            case 17: return 'Seventeen';
                            case 18: return 'Eighteen';
                            case 19: return 'Nineteen';
                        }
                    }

                    // 处理20-99的读法
                    let tenPart = aviationNumbers[firstDigit]
                        .replace('Two', 'Twenty')
                        .replace('Tree', 'Thirty')
                        .replace('Four', 'Forty')
                        .replace('Five', 'Fifty')
                        .replace('Six', 'Sixty')
                        .replace('Seven', 'Seventy')
                        .replace('Eight', 'Eighty')
                        .replace('Niner', 'Ninety');

                    if (secondDigit === '0') {
                        return tenPart; // 整十数如30 -> Thirty
                    } else {
                        return `${tenPart} ${aviationNumbers[secondDigit]}`; // 非整十数如34 -> Thirty Four
                    }
                }

                function convertSingleNumber(numChar) {
                    return aviationNumbers[numChar];
                }
        
                // 修改答案显示逻辑
                function updateAnswer() {
                    const div = document.getElementById('answer');
                    div.textContent = currentAnswer.raw;
                    document.getElementById('userAnswer').value = '';
                    document.getElementById('answerFeedback').textContent = '';
                    document.getElementById('answerFeedback').className = 'feedback';
                }

                function updateSpeed(v) {
                    document.getElementById('speedValue').textContent = v;
                }
        
                function toggleAnswer() {
                    const div = document.getElementById('answer');
                    const icon = document.getElementById('toggleIcon');
                    const text = document.getElementById('toggleText');
                    
                    if(div.style.display === 'none') {
                        div.style.display = 'block';
                        icon.textContent = '👁️';
                        text.textContent = '隐藏答案';
                    } else {
                        div.style.display = 'none';
                        icon.textContent = '🔍';
                        text.textContent = '显示答案';
                    }
                }
        
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden) {
                        stopPlayback();
                    }
                });
            
                // 改进的答案核对函数
                function checkAnswer() {
                    const cleanInput = (str) => str.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    const userInput = document.getElementById('userAnswer').value;
                    const feedbackDiv = document.getElementById('answerFeedback');
                    
                    // 清空反馈样式
                    feedbackDiv.className = 'feedback';
                    feedbackDiv.innerHTML = '';

                    // 处理呼号模式
                    if(currentAnswer.type === 'callsigns') {
                        // 拆分用户输入为多个呼号（允许任意分隔符）
                        const userCallsigns = userInput.split(/[^a-zA-Z0-9]+/)
                            .filter(Boolean)
                            .map(cleanInput);

                        // 答案验证逻辑
                        const expected = currentAnswer.elements;
                        let errorDetails = [];
                        
                        // 检查数量匹配
                        if(userCallsigns.length !== expected.length) {
                            feedbackDiv.innerHTML = `
                                <div class="error-header">⚠ 需要${expected.length}个呼号，你输入了${userCallsigns.length}个</div>
                                <div class="correct-all">正确答案：${expected.join(', ')}</div>
                            `;
                            feedbackDiv.className += ' incorrect';

                            // 新增：提交答案后，移除输入框焦点
                             document.getElementById('userAnswer').blur(); // 新增：移除输入框焦点

                            return;
                        }

                        // 逐个比较呼号并记录错误细节
                        expected.forEach((correct, index) => {
                            const userAnswer = userCallsigns[index];
                            if(userAnswer !== correct) {
                                errorDetails.push({
                                    position: index + 1,
                                    user: userAnswer || "[空输入]",
                                    correct: correct
                                });
                            }
                        });

                        // 构建反馈信息
                        if(errorDetails.length === 0) {
                            feedbackDiv.innerHTML = '✅ 所有呼号正确！';
                            feedbackDiv.className += ' correct';
                        } else {
                            let errorList = errorDetails.map(err => 
                                `- 第${err.position}个呼号错误：应为 <span class="correct-highlight">${err.correct}</span>，你输入了 <span class="user-error">${err.user}</span>`
                            ).join('<br>');

                            feedbackDiv.innerHTML = `
                                <div class="error-header">⚠ 发现 ${errorDetails.length} 处错误：</div>
                                <div class="error-details">${errorList}</div>
                                <div class="correct-all">正确答案：${expected.join(', ')}</div>
                            `;
                            feedbackDiv.className += ' incorrect';
                        }
                    }
                    // 字母模式保持原有逻辑
                    else if(currentAnswer.type === 'letters') {
                        const userClean = cleanInput(userInput);
                        const correctClean = cleanInput(currentAnswer.raw);
                        
                        if(userClean === correctClean) {
                            feedbackDiv.textContent = '✅ 答案正确！';
                            feedbackDiv.className += ' correct';
                        } else {
                            feedbackDiv.textContent = `⚠ 答案错误，正确答案：${currentAnswer.raw}`;
                            feedbackDiv.className += ' incorrect';
                        }
                    }
                        // 在已有代码的if结构中添加：
                    else if(currentAnswer.type.startsWith('format')) {
                        const cleanInput = (str) => str.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        const userAnswers = userInput.split(/[^a-zA-Z0-9]+/)
                            .filter(Boolean)
                            .map(s => currentAnswer.type === 'format2' ? 
                                s.replace(/D$/i, '') + 'D' : // 标准化D后缀
                                s.padStart(4, '0').substring(0,4));
                        
                        const expected = currentAnswer.elements;
                        let errors = [];
                        
                        if(userAnswers.length !== expected.length) {
                            showFeedback(`⚠ 需要${expected.length}个呼号，你输入了${userAnswers.length}个`, false);

                            // 新增：提交答案后，移除输入框焦点
                            document.getElementById('userAnswer').blur(); // 新增：移除输入框焦点

                            return;
                        }
                        
                        userAnswers.forEach((answer, i) => {
                            const cleanAnswer = cleanInput(answer);
                            const cleanExpected = cleanInput(expected[i]);
                            if(cleanAnswer !== cleanExpected) errors.push(`⚠ 第${i+1}个呼号错误，应为 ${expected[i]}`);
                        });
                        
                        if(errors.length > 0) {
                            showFeedback(errors.join('<br>') + `<br>正确答案：${expected.join(', ')}`, false);
                        } else {
                            showFeedback('✅ 所有呼号正确！', true);
                        }
                    }

                    // 新增：提交答案后，移除输入框焦点
                    document.getElementById('userAnswer').blur(); // 新增：移除输入框焦点
                }
            
                // 添加辅助显示函数
                function showFeedback(message, isCorrect) {
                    const feedbackDiv = document.getElementById('answerFeedback');
                    feedbackDiv.innerHTML = message;
                    feedbackDiv.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                }
                
                // 在脚本末尾添加键盘事件监听
                document.addEventListener('keydown', handleKeyboardShortcuts);

                // 键盘处理函数
                function handleKeyboardShortcuts(event) {
                    const activeTag = document.activeElement.tagName.toLowerCase();
                    
                    // 排除输入框聚焦状态
                    if (activeTag === 'input' || activeTag === 'textarea') return;

                    switch(event.key.toLowerCase()) {
                        case ' ': // 空格键：播放/暂停
                            event.preventDefault();
                            togglePauseResume();
                            break;
                            
                        case 'enter': // 回车键：提交答案
                            event.preventDefault();
                            checkAnswer();
                            break;
                            
                        case 'arrowleft': // 左箭头：减慢语速
                            adjustSpeed(-0.1);
                            break;
                            
                        case 'arrowright': // 右箭头：加快语速
                            adjustSpeed(0.1);
                            break;
                            
                        case 'r': // R键：重新生成题目
                            if(event.ctrlKey) break; // 避免与浏览器刷新冲突
                            event.preventDefault();
                            if(currentAnswer.type === 'callsigns') playSimulated();
                            else if(currentAnswer.type === 'letters') playLetters();
                            break;
                            
                        case 'h': // H键：显示/隐藏答案
                            event.preventDefault();
                            toggleAnswer();
                            break;
                    }
                }

            
            </script>
        </section>
    </main>

    <footer>
        <div class="footer-content">
          <p>© 2025 Yohann飞行笔记 保留所有权利。</p>
          <p>
            本项目基于 <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank">GNU AGPLv3 许可证</a>，
            仅供非商业用途。引用内容已标注来源，版权信息请联系 <a href="yuhan_zhao@nuaa.edu.cn">Email</a>。
          </p>
        </div>
      </footer>
</body>
</html>
