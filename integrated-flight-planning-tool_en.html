<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flight Planning Tool | Flight Training |Yohann Aviation Note</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G3TQJTQ67B"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-G3TQJTQ67B');
  </script>

  <style>
  /* ===== Light Blue Theme (统一风格) ===== */
  :root{
    --bg: #f5f9ff;
    --bg-1: #eef5ff;
    --panel: #ffffff;
    --card: #ffffff;
    --text: #1f2a44;
    --muted: #5b6b80;
    --brand: #1976d2;
    --brand-2: #64b5f6;
    --ok: #0ea5e9;
    --warn: #f59e0b;
    --bad: #ef4444;
    --border: #e6eef8;
    --border-dashed: #d7e5fb;
    --shadow: 0 8px 28px rgba(25, 118, 210, .12), 0 2px 10px rgba(15, 23, 42, .06);
    --radius: 16px;
    --fs-base: 16px;
    --maxw: 980px;
    --scrollbar-track: #f1f6ff;
    --scrollbar-thumb: #c9ddfb;
    --scrollbar-thumb-hover: #aaceff;
  }
  html { font-size: var(--fs-base); }
  body{
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color: var(--text);
    background:
      radial-gradient(1200px 600px at 10% -10%, #eaf3ff 0%, rgba(234,243,255,0) 60%),
      radial-gradient(800px 520px at 95% -10%, #f0f7ff 0%, rgba(240,247,255,0) 60%),
      linear-gradient(180deg, var(--bg), var(--bg-1) 60%, #f7fbff 100%);
  }
  .wrap{ max-width: var(--maxw); margin: 0 auto; padding: clamp(14px,3vw,20px); }
  .card{
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow);
  }
  .grid{ display: grid; grid-template-columns: repeat(12,1fr); gap: clamp(8px,2.5vw,12px); }
  .col-6{ grid-column: span 6; }
  .col-4{ grid-column: span 4; }
  .col-3{ grid-column: span 3; }
  .col-12{ grid-column: span 12; }
  label{ display: block; font-weight: 600; margin: 2px 0 6px; color: var(--muted); }
  input[type=number], select{
    width: 100%; box-sizing: border-box; background: var(--panel); color: var(--text);
    border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; outline: none;
    font-size: 16px; min-height: 44px;
    box-shadow: var(--shadow);
    background-clip: padding-box;
  }
  input::placeholder{ color: #7d8aa4; }
  .units{ opacity: .7; margin-left: 6px; }
  .hint{ font-size: 12px; color: var(--muted); }
  .row{ display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  button, .btn{
    border: 1px solid var(--border); background: var(--panel); color: var(--text);
    padding: 4px 10px; border-radius: 8px; cursor: pointer; text-decoration: none;
    min-height: 0; font-size: 14px; font-weight: 500; line-height: 1.1; height: auto;
    box-shadow: none;
    transition: border-color .15s, box-shadow .15s, transform .02s;
  }
  button.secondary{ opacity: .85; }
  button:hover, .btn:hover{ border-color: #cfe0fb; }
  button:active, .btn:active{ transform: translateY(1px); }
  button:focus-visible, .btn:focus-visible{
    outline: 3px solid rgba(25,118,210,.25); outline-offset: 2px;
  }
  .pill{
    background: #f4f9ff; border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px;
    box-shadow: var(--shadow);
  }
  .pill h3{ font-size: 12px; opacity: .75; margin: 0 0 6px; color: var(--muted); }
  .pill .value{ font-size: 18px; font-weight: 700; color: var(--brand); }
  .note{ font-size: 13px; color: var(--warn); margin-top: 8px; }
  .bar{ display: flex; gap: 10px; align-items: center; justify-content: space-between; margin: 8px 0 6px; flex-wrap: wrap; }
  .tight{ margin-top: 10px; }
  .sep{ height: 1px; background: var(--border); margin: 18px 0; }
  .small{ font-size: 12px; color: var(--muted); }
  .right{ margin-left: auto; }
  .group{ border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: #f4f9ff; }
  .group--a{ background: #eaf3ff; }
  .group--b{ background: #e0f7fa; }
  .group h3{ margin: 0 0 8px; font-size: 13px; letter-spacing: .3px; opacity: .9; color: var(--brand); }
  .topbar{
    display: flex; gap: 12px; align-items: center; justify-content: space-between;
    background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius);
    padding: calc(10px + env(safe-area-inset-top,0)) 12px 10px;
    margin-bottom: 12px; position: sticky; top: max(8px, env(safe-area-inset-top,0));
    z-index: 10; backdrop-filter: saturate(120%) blur(6px); flex-wrap: wrap;
    box-shadow: var(--shadow);
  }
  .lang{ display: flex; align-items: center; gap: 6px; }
  .lang a{ color: var(--text); text-decoration: none; padding: 4px 8px; border-radius: 8px; }
  .lang a.active{ outline: 1px solid rgba(148,163,184,.35); background: #f4f9ff; }
  .table-wrap{ overflow: auto; -webkit-overflow-scrolling: touch; border-radius: 12px; border: 1px solid var(--border); }
  table{ width: 100%; border-collapse: separate; border-spacing: 0; margin: 0; }
  th,td{ border-top: 1px solid var(--border); border-left: 1px solid var(--border); padding: 10px 12px; text-align: left; white-space: nowrap; }
  th:first-child, td:first-child{ border-top-left-radius: 10px; }
  th:last-child, td:last-child{ border-top-right-radius: 10px; }
  tr:last-child td:first-child{ border-bottom-left-radius: 10px; }
  tr:last-child td:last-child{ border-bottom-right-radius: 10px; }
  th{ background: #f7fbff; color: var(--muted); font-weight: 700; }
  td{ background: #f4f9ff; }
  .footer{ margin-top: 16px; text-align: center; opacity: .78; color: var(--muted); }
  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                 "Liberation Mono", "Courier New", monospace;
    letter-spacing: .2px;
  }
  @media (max-width: 720px){
    .col-3, .col-4, .col-6{ grid-column: span 12; }
    .pill .value{ font-size: 17px; }
    .bar{ flex-direction: column; align-items: stretch; }
    .right{ margin-left: 0; }
    .topbar{ gap: 8px; }
    .lang{ margin-left: auto; }
  }
  mark.hl{
    background: rgba(25,118,210,.22);
    color: inherit; padding: 0 .15em; border-radius: .2em;
    box-shadow: 0 0 0 1px rgba(25,118,210,.18) inset;
  }
  a{ color: var(--brand); }
  a:hover{ color: #0f5fb3; text-decoration: underline; }
  </style>

    <link rel="icon" type="image/x-icon" href="yohann_favicon.ico">
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="flight-training_en.html">← Back to previous page</a>
      <div class="lang small">
        <span>Language:</span>
        <a href="integrated-flight-planning-tool.html">中文</a>
        <span>·</span>
        <a href="integrated-flight-planning-tool_en.html" class="active" aria-current="page">English</a>
      </div>
    </div>

    <h1>Flight Planning Tool | Yohann Aviation Note</h1>

    <!-- Step 1 -->
    <h2>Step 1 · Calculate wind at target altitude by GPWT <span class="small">(You can skip this and go straight to Step 2)</span></h2>
    <div class="card" id="step1">
      <div class="grid">
        <div class="col-6">
          <div class="group group--a">
            <h3>Altitude block A</h3>
            <div class="grid">
              <div class="col-6">
                <label for="s1_alt1">Altitude 1 <span class="units">ft</span></label>
                <select id="s1_alt1">
                  <option>14000</option><option>10000</option><option>7000</option>
                  <option selected>5000</option><option>2000</option><option>1000</option>
                </select>
              </div>
              <div class="col-6">
                <label for="s1_dir1">Wind dir 1 (M · from) <span class="units">°</span></label>
                <input id="s1_dir1" type="number" inputmode="decimal" min="0" max="359.9" step="0.1" placeholder="e.g. 270.0" />
              </div>
              <div class="col-6">
                <label for="s1_spd1">Wind spd 1 <span class="units">kt</span></label>
                <input id="s1_spd1" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 25" />
              </div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="group group--b">
            <h3>Altitude block B</h3>
            <div class="grid">
              <div class="col-6">
                <label for="s1_alt2">Altitude 2 <span class="units">ft</span></label>
                <select id="s1_alt2">
                  <option>14000</option><option>10000</option><option>7000</option>
                  <option selected>5000</option><option>2000</option><option>1000</option>
                </select>
              </div>
              <div class="col-6">
                <label for="s1_dir2">Wind dir 2 (M · from) <span class="units">°</span></label>
                <input id="s1_dir2" type="number" inputmode="decimal" min="0" max="359.9" step="0.1" placeholder="e.g. 240.0" />
              </div>
              <div class="col-6">
                <label for="s1_spd2">Wind spd 2 <span class="units">kt</span></label>
                <input id="s1_spd2" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 35" />
              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="group">
            <label for="s1_target">Target altitude <span class="units">ft</span></label>
            <input id="s1_target" type="number" inputmode="decimal" min="0" step="50" placeholder="e.g. 6500" />
            <div class="hint">Prefer an altitude between A and B; if out of range, result will be an extrapolation.</div>
          </div>
        </div>

        <div class="col-6">
          <div class="pill"><h3>Wind dir at target (M · from)</h3><div class="value" id="s1_out_dir">—</div></div>
        </div>
        <div class="col-6">
          <div class="pill"><h3>Wind spd at target</h3><div class="value" id="s1_out_spd">—</div></div>
        </div>

        <div class="col-12 note" id="s1_note" aria-live="polite"></div>

        <div class="col-12" style="display:flex; justify-content:flex-end; gap:10px">
          <button class="secondary" id="s1_clear" type="button">Clear (Step 1)</button>
        </div>
      </div>
      <div class="small" style="margin-top:10px; opacity:.85">
        Note: This page does not provide a direct True→Magnetic conversion. Doing the mental math for True→Magnetic during planning helps build robust habits (variation/deviation contexts often cause errors). Practice it deliberately 😉
      </div>
    </div>

    <div class="sep"></div>

    <!-- Step 2 -->
    <h2>Step 2 · TRK + wind → MH & GS <span class="small">(Pre-fills from Step 1 when available; you can overwrite here)</span></h2>
    <div class="card" id="step2">
      <div class="bar">
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <span class="small">Leg template:</span>
          <select id="leg_template">
            <option value="">— Select a leg —</option>
          </select>
          <span class="small">TAS template:</span>
          <select id="tas_template">
            <option value="125" selected>DA40NG · 125 kt (default)</option>
            <option value="160">DA42 · 160 kt</option>
            <option value="">Custom</option>
          </select>
        </div>
        <button class="secondary right" id="s2_clear" type="button">Clear (Step 2)</button>
      </div>

      <div class="grid tight">
        <div class="col-3">
          <label for="s2_trk">TRK (magnetic) <span class="units">°</span></label>
          <input id="s2_trk" type="number" inputmode="decimal" min="0" max="359.9" step="0.1" placeholder="e.g. 359" />
        </div>
        <div class="col-3">
          <label for="s2_tas">TAS <span class="units">kt</span></label>
          <input id="s2_tas" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 125" />
        </div>
        <div class="col-3" id="s2_wdir_wrap">
          <label for="s2_wdir">Wind dir (M · from) <span class="units">°</span></label>
          <input id="s2_wdir" type="number" inputmode="decimal" min="0" max="359.9" step="0.1" placeholder="e.g. 340" />
          <div class="hint" id="s2_wdir_hint">Pre-filled from Step 1; editing here clears Step 1.</div>
        </div>
        <div class="col-3" id="s2_wspd_wrap">
          <label for="s2_wspd">Wind spd <span class="units">kt</span></label>
          <input id="s2_wspd" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 12" />
        </div>

        <div class="col-6">
          <div class="pill"><h3>MH (magnetic heading)</h3><div class="value" id="s2_out_mh">—</div></div>
        </div>
        <div class="col-6">
          <div class="pill"><h3>GS (ground speed)</h3><div class="value" id="s2_out_gs">—</div></div>
        </div>
        <div class="col-12 note" id="s2_note" aria-live="polite"></div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- Step 3 -->
    <h2>Step 3 · ETI (Estimated Time Interval)</h2>
    <div class="card" id="step3">
      <div class="bar">
        <span class="small">DIST links to the leg template; manual edits will clear the selection.</span>
        <button class="secondary right" id="s3_clear" type="button">Clear (Step 3)</button>
      </div>
      <div class="grid tight">
        <div class="col-4">
          <label for="s3_dist">DIST <span class="units">nm</span></label>
          <input id="s3_dist" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 68" />
        </div>
        <div class="col-4">
          <div class="pill"><h3>ETI</h3><div class="value" id="s3_out_eti">—</div></div>
        </div>
        <div class="col-4 small" style="display:flex;align-items:center">Formula: ETI = DIST / GS × 60</div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- Step 4 -->
    <h2>Step 4 · Trip fuel</h2>
    <div class="card" id="step4">
      <div class="bar">
        <div class="row">
          <span class="small">Fuel flow template (DA40NG default):</span>
          <select id="ff_template">
            <option value="25" selected>DA40NG · 25 L/h (default)</option>
            <option value="45">DA42 · 45 L/h</option>
            <option value="">Custom</option>
          </select>
        </div>
        <button class="secondary right" id="s4_clear" type="button">Clear (Step 4)</button>
      </div>
      <div class="grid tight">
        <div class="col-4">
          <label for="s4_ff">Fuel flow <span class="units">L/h</span></label>
          <input id="s4_ff" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 25" />
        </div>
        <div class="col-4">
          <div class="pill"><h3>Trip fuel</h3><div class="value" id="s4_out_fuel">—</div></div>
        </div>
        <div class="col-4 small" style="display:flex;align-items:center">Trip fuel = ETI / 60 × Fuel flow (rounded up to whole litres)</div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- Step 5 -->
    <h2>Step 5 · Summary</h2>
    <div class="card" id="step5">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>TRK (M)</th>
              <th>Wind</th>
              <th>HDG (M)</th>
              <th>GS</th>
              <th>DIST</th>
              <th>ETI</th>
              <th>Trip fuel</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="t_trk">—</td>
              <td id="t_wind">—</td>
              <td id="t_mh">—</td>
              <td id="t_gs">—</td>
              <td id="t_dist">—</td>
              <td id="t_eti">—</td>
              <td id="t_fuel">—</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:8px">Wind example format: <span class="mono">340M/06kt</span></div>
      <div class="footer">© Yohann Aviation Note. All rights reserved.</div>
    </div>
  </div>

<script>
/* ===== Utilities ===== */
const deg2rad = d => (d * Math.PI) / 180;
const rad2deg = r => (r * 180) / Math.PI;
const norm360 = d => { let x = d % 360; if (x < 0) x += 360; return x; };
const pad2 = n => String(Math.abs(Math.round(n))).padStart(2,'0');
const pad3 = n => String(Math.abs(Math.round(n))).padStart(3,'0');
const fmtDegM = d => Number.isFinite(d) ? pad3(norm360(Math.round(d))) + '\u00B0M' : '—';
const fmtMin = m => Number.isFinite(m) ? (m<10?m.toFixed(1):Math.round(m)) + ' min' : '—';
const fmtFuel = x => Number.isFinite(x) ? Math.round(x) + ' L' : '—';
const fmtWind = (dir, spd) => (Number.isFinite(dir) && Number.isFinite(spd)) ? `${pad3(Math.round(norm360(dir)))}M/${pad2(spd)}kt` : '—';
function parseNum(id){ const el=document.querySelector(id); const v=parseFloat(el.value); return Number.isFinite(v)?v:null; }

/* Met wind (FROM) in (u,v) and back */
function fromDirSpdToUV(dirDeg, spd){
  if(!Number.isFinite(dirDeg)||!Number.isFinite(spd)) return {u:NaN,v:NaN};
  const r=deg2rad(dirDeg);
  const u = -spd * Math.sin(r);
  const v = -spd * Math.cos(r);
  return {u,v};
}
function uvToFromDirSpd(u,v){
  const spd = Math.hypot(u,v);
  const dir = norm360(rad2deg(Math.atan2(u,v))+180);
  return {dir, spd};
}

/* ===== Global state ===== */
const state = {
  s1: {dir:null, spd:null, valid:false},
  s2: {trk:null, tas:null, wdir:null, wspd:null, mh:null, gs:null},
  s3: {dist:null, eti:null},
  s4: {ff:null, fuel:null},
  flags: { applyingLeg:false }
};

function updateSummary(){
  document.querySelector('#t_trk').textContent = fmtDegM(state.s2.trk);
  document.querySelector('#t_wind').textContent = fmtWind(activeWindDir(), activeWindSpd());
  document.querySelector('#t_mh').textContent = fmtDegM(state.s2.mh);
  document.querySelector('#t_gs').textContent = Number.isFinite(state.s2.gs) ? Math.round(state.s2.gs)+' kt' : '—';
  document.querySelector('#t_dist').textContent = Number.isFinite(state.s3.dist) ? (+state.s3.dist).toFixed(0)+' nm' : '—';
  document.querySelector('#t_eti').textContent = fmtMin(state.s3.eti);
  document.querySelector('#t_fuel').textContent = fmtFuel(state.s4.fuel);
}

/* ===== Step 1: Interpolation ===== */
function step1Compute(){
  const alt1=parseNum('#s1_alt1');
  const alt2=parseNum('#s1_alt2');
  const d1=parseNum('#s1_dir1');
  const s1=parseNum('#s1_spd1');
  const d2=parseNum('#s1_dir2');
  const s2=parseNum('#s1_spd2');
  const at=parseNum('#s1_target');

  const noteEl = document.querySelector('#s1_note');
  noteEl.textContent='';
  let outDir=null,outSpd=null, valid=false;

  if([alt1,alt2,d1,s1,d2,s2,at].every(v=>v!==null)){
    if(alt1===alt2){ noteEl.textContent='⚠️ Altitude 1 and 2 cannot be the same.'; }
    else if(s1<0||s2<0){ noteEl.textContent='⚠️ Wind speed must be non‑negative.'; }
    else{
      const {u:u1,v:v1}=fromDirSpdToUV(norm360(d1),s1);
      const {u:u2,v:v2}=fromDirSpdToUV(norm360(d2),s2);
      const t=(at-alt1)/(alt2-alt1);
      const u=u1 + t*(u2-u1);
      const v=v1 + t*(v2-v1);
      const r=uvToFromDirSpd(u,v);
      outDir=r.dir; outSpd=r.spd; valid=Number.isFinite(outDir)&&Number.isFinite(outSpd);
      if(t<0||t>1){ noteEl.textContent='⚠️ Target altitude is outside the two levels (extrapolation).'; }
    }
  }
  state.s1 = {dir: outDir, spd: outSpd, valid};
  document.querySelector('#s1_out_dir').textContent = Number.isFinite(outDir) ? pad3(Math.round(outDir))+'°M' : '—';
  document.querySelector('#s1_out_spd').textContent = Number.isFinite(outSpd) ? Math.round(outSpd)+' kt' : '—';

  if(valid){
    document.querySelector('#s2_wdir').value = Math.round(outDir);
    document.querySelector('#s2_wspd').value = Math.round(outSpd);
  }
  document.querySelector('#s2_wdir_hint').textContent = 'Pre-filled from Step 1; editing here clears Step 1.';

  step2Compute();
}

function step1Clear(){
  ['#s1_dir1','#s1_spd1','#s1_dir2','#s1_spd2','#s1_target'].forEach(id=>document.querySelector(id).value='');
  document.querySelector('#s1_alt1').value='7000';
  document.querySelector('#s1_alt2').value='1000';
  document.querySelector('#s1_note').textContent='';
  state.s1={dir:null,spd:null,valid:false};
  document.querySelector('#s1_out_dir').textContent='—';
  document.querySelector('#s1_out_spd').textContent='—';
  step2Compute();
}

/* ===== Step 2: MH/GS ===== */
function activeWindDir(){ return state.s1.valid ? state.s1.dir : state.s2.wdir; }
function activeWindSpd(){ return state.s1.valid ? state.s1.spd : state.s2.wspd; }

/* ★ Single source: Leg templates (edit here only) */
const LEG_DATA = [
  { id:'YPMQ-YCFS', from:'YPMQ', to:'YCFS', trk:359, dist:68 },
  { id:'YCFS-YPMQ', from:'YCFS', to:'YPMQ', trk:179, dist:68 },
  { id:'YCFS-YGFN', from:'YCFS', to:'YGFN', trk:340, dist:34 },
  { id:'YGFN-YCFS', from:'YGFN', to:'YCFS', trk:160, dist:34 },
  { id:'YGFN-RER',  from:'YGFN', to:'RER',  trk:131, dist:17 },
  { id:'RER-YCFS',  from:'RER',  to:'YCFS', trk:184, dist:21 },
  { id:'YPMQ-YSTW', from:'YPMQ', to:'YSTW', trk:269, dist:107},
  { id:'YSTW-YPMQ', from:'YSTW', to:'YPMQ', trk:91,  dist:107},
  { id:'PMQ-TW', from:'PMQ', to:'TW', trk:269, dist:107},
  { id:'TW-PMQ', from:'TW', to:'PMQ', trk:91,  dist:107},
  { id:'YPMQ-YARM', from:'YPMQ', to:'YARM', trk:298, dist:84 },
  { id:'YARM-YPMQ', from:'YARM', to:'YPMQ', trk:119, dist:84 },
  { id:'YPMQ-YTRE', from:'YPMQ', to:'YTRE', trk:202, dist:33 },
  { id:'YTRE-YPMQ', from:'YTRE', to:'YPMQ', trk:22,  dist:33 },
  { id:'YPMQ-YKMP', from:'YPMQ', to:'YKMP', trk:335, dist:22 },
  { id:'YKMP-YPMQ', from:'YKMP', to:'YPMQ', trk:155, dist:22 },
];

const LEG_INDEX = Object.fromEntries(LEG_DATA.map(l => [l.id, l]));

function populateLegOptions(){
  const sel = document.querySelector('#leg_template');
  while(sel.options.length > 1) sel.remove(1);
  for(const leg of LEG_DATA){
    const opt = document.createElement('option');
    opt.value = leg.id;
    opt.textContent = `${leg.from} → ${leg.to} · TRK ${leg.trk}°M · ${leg.dist}nm`;
    sel.appendChild(opt);
  }
}

function step2Compute(){
  state.s2.trk = parseNum('#s2_trk');
  state.s2.tas = parseNum('#s2_tas');
  state.s2.wdir = parseNum('#s2_wdir');
  state.s2.wspd = parseNum('#s2_wspd');

  const trk=state.s2.trk, tas=state.s2.tas, wdir=activeWindDir(), wspd=activeWindSpd();
  const noteEl=document.querySelector('#s2_note');
  noteEl.textContent='';
  let mh=null, gs=null;

  if([trk,tas,wdir,wspd].every(v=>Number.isFinite(v))){
    if(tas<=0){ noteEl.textContent='⚠️ TAS must be greater than 0.'; }
    else{
      const windTo = norm360(wdir+180);
      const d = deg2rad(windTo - trk);
      const cross = wspd * Math.sin(d);
      const head = wspd * Math.cos(d);
      const ratio = Math.abs(cross) / tas;
      if(ratio>1){
        noteEl.textContent = '⚠️ Crosswind exceeds TAS; maintaining this TRK is not possible.';
      } else {
        const drift = Math.asin(cross / tas);
        mh = norm360(trk - rad2deg(drift));
        gs = tas * Math.cos(drift) + head;
      }
    }
  }
  state.s2.mh = Number.isFinite(mh)?mh:null;
  state.s2.gs = Number.isFinite(gs)?gs:null;

  document.querySelector('#s2_out_mh').textContent = fmtDegM(state.s2.mh);
  document.querySelector('#s2_out_gs').textContent = Number.isFinite(state.s2.gs)? Math.round(state.s2.gs)+' kt' : '—';

  step3Compute();
}

function step2Clear(){
  ['#s2_trk','#s2_tas','#s2_wdir','#s2_wspd'].forEach(id=>document.querySelector(id).value='');
  document.querySelector('#leg_template').value='';
  document.querySelector('#tas_template').value='';
  document.querySelector('#s2_note').textContent='';
  state.s2={trk:null,tas:null,wdir:null,wspd:null,mh:null,gs:null};
  step3Compute();
}

function clearStep1OnWindEdit(){
  const anyFilled = ['#s1_dir1','#s1_spd1','#s1_dir2','#s1_spd2','#s1_target'].some(sel=>document.querySelector(sel).value.trim()!=='');
  if(state.s1.valid || anyFilled){ step1Clear(); }
}

function applyLegTemplate(v){
  state.flags.applyingLeg = true;
  const leg = LEG_INDEX[v];
  if(leg){
    document.querySelector('#s2_trk').value  = String(leg.trk);
    document.querySelector('#s3_dist').value = String(leg.dist);
  }
  state.flags.applyingLeg = false;
  step2Compute();
}

/* ===== Step 3: ETI ===== */
function step3Compute(){
  state.s3.dist = parseNum('#s3_dist');
  const gs = state.s2.gs;
  let eti=null;
  if(Number.isFinite(state.s3.dist) && Number.isFinite(gs) && gs>0){
    eti = state.s3.dist / gs * 60;
  }
  state.s3.eti = Number.isFinite(eti)?eti:null;
  document.querySelector('#s3_out_eti').textContent = fmtMin(state.s3.eti);
  step4Compute();
}

function step3Clear(){
  document.querySelector('#s3_dist').value='';
  state.s3={dist:null,eti:null};
  document.querySelector('#s3_out_eti').textContent='—';
  step4Compute();
}

/* ===== Step 4: Trip fuel ===== */
function step4Compute(){
  const ff = parseNum('#s4_ff');
  state.s4.ff = ff;
  const eti = state.s3.eti;
  let fuel=null;
  if(Number.isFinite(eti) && Number.isFinite(ff)){
    fuel = Math.ceil(eti/60 * ff);
  }
  state.s4.fuel = Number.isFinite(fuel)?fuel:null;
  document.querySelector('#s4_out_fuel').textContent = fmtFuel(state.s4.fuel);
  updateSummary();
}

function step4Clear(){
  document.querySelector('#ff_template').value='';
  document.querySelector('#s4_ff').value='';
  state.s4={ff:null,fuel:null};
  document.querySelector('#s4_out_fuel').textContent='—';
  updateSummary();
}

/* ===== Event bindings ===== */
['#s1_alt1','#s1_alt2'].forEach(sel=>document.querySelector(sel).addEventListener('change', step1Compute));
['#s1_dir1','#s1_spd1','#s1_dir2','#s1_spd2','#s1_target'].forEach(sel=>document.querySelector(sel).addEventListener('input', step1Compute));

document.querySelector('#s1_clear').addEventListener('click', step1Clear);

['#s2_trk','#s2_tas','#s2_wdir','#s2_wspd'].forEach(sel=>document.querySelector(sel).addEventListener('input', step2Compute));
['#s2_wdir','#s2_wspd'].forEach(sel=>document.querySelector(sel).addEventListener('input', clearStep1OnWindEdit));

document.querySelector('#s2_clear').addEventListener('click', step2Clear);

document.querySelector('#leg_template').addEventListener('change', (e)=>applyLegTemplate(e.target.value));

document.querySelector('#tas_template').addEventListener('change', (e)=>{
  const v=e.target.value; if(v){ document.querySelector('#s2_tas').value=v; } else {/* custom */}
  step2Compute();
});
document.querySelector('#s2_tas').addEventListener('input', ()=>{ document.querySelector('#tas_template').value=''; });

/* Step3: manual DIST edit clears leg selection (but keeps other fields) */
document.querySelector('#s3_dist').addEventListener('input', ()=>{
  if(!state.flags.applyingLeg){ document.querySelector('#leg_template').value=''; }
  step3Compute();
});
document.querySelector('#s3_clear').addEventListener('click', step3Clear);

/* Step4 */
document.querySelector('#ff_template').addEventListener('change', (e)=>{
  const v=e.target.value; if(v){ document.querySelector('#s4_ff').value=v; } else { /* keep custom */ }
  step4Compute();
});
document.querySelector('#s4_ff').addEventListener('input', ()=>{ document.querySelector('#ff_template').value=''; step4Compute(); });
document.querySelector('#s4_clear').addEventListener('click', step4Clear);

/* ===== Init ===== */
(function initDefaults(){
  document.querySelector('#tas_template').value='125';
  document.querySelector('#s2_tas').value='125';
  document.querySelector('#ff_template').value='25';
  document.querySelector('#s4_ff').value='25';
  populateLegOptions();
})();

step1Compute();
updateSummary();
</script>
</body>
</html>

